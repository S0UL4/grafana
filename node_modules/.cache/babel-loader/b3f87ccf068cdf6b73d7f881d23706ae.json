{"ast":null,"code":"import React, { useCallback, useLayoutEffect, useRef, useState } from 'react';\nimport { useMountedState } from 'react-use';\nimport { AnnotationEditor } from './annotations/AnnotationEditor';\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\n\n/**\n * @alpha\n */\nexport const AnnotationEditorPlugin = ({\n  data,\n  timeZone,\n  config,\n  children\n}) => {\n  const plotInstance = useRef();\n  const [bbox, setBbox] = useState();\n  const [isAddingAnnotation, setIsAddingAnnotation] = useState(false);\n  const [selection, setSelection] = useState(null);\n  const isMounted = useMountedState();\n  const clearSelection = useCallback(() => {\n    setSelection(null);\n\n    if (plotInstance.current) {\n      plotInstance.current.setSelect({\n        top: 0,\n        left: 0,\n        width: 0,\n        height: 0\n      });\n    }\n\n    setIsAddingAnnotation(false);\n  }, [setIsAddingAnnotation, setSelection]);\n  useLayoutEffect(() => {\n    let annotating = false;\n    config.addHook('init', u => {\n      plotInstance.current = u; // Wrap all setSelect hooks to prevent them from firing if user is annotating\n\n      const setSelectHooks = u.hooks.setSelect;\n\n      if (setSelectHooks) {\n        for (let i = 0; i < setSelectHooks.length; i++) {\n          const hook = setSelectHooks[i];\n\n          if (hook !== setSelect) {\n            setSelectHooks[i] = (...args) => {\n              !annotating && hook(...args);\n            };\n          }\n        }\n      }\n    }); // cache uPlot plotting area bounding box\n\n    config.addHook('syncRect', (u, rect) => {\n      if (!isMounted()) {\n        return;\n      }\n\n      setBbox(rect);\n    });\n\n    const setSelect = u => {\n      if (annotating) {\n        setIsAddingAnnotation(true);\n        setSelection({\n          min: u.posToVal(u.select.left, 'x'),\n          max: u.posToVal(u.select.left + u.select.width, 'x'),\n          bbox: {\n            left: u.select.left,\n            top: 0,\n            height: u.select.height,\n            width: u.select.width\n          }\n        });\n        annotating = false;\n      }\n    };\n\n    config.addHook('setSelect', setSelect);\n    config.setCursor({\n      bind: {\n        mousedown: (u, targ, handler) => e => {\n          annotating = e.button === 0 && (e.metaKey || e.ctrlKey);\n          handler(e);\n          return null;\n        },\n        mouseup: (u, targ, handler) => e => {\n          // uPlot will not fire setSelect hooks for 0-width && 0-height selections\n          // so we force it to fire on single-point clicks by mutating left & height\n          if (annotating && u.select.width === 0) {\n            u.select.left = u.cursor.left;\n            u.select.height = u.bbox.height / window.devicePixelRatio;\n          }\n\n          handler(e);\n          return null;\n        }\n      }\n    });\n  }, [config, setBbox, isMounted]);\n  const startAnnotating = useCallback(({\n    coords\n  }) => {\n    if (!plotInstance.current || !bbox || !coords) {\n      return;\n    }\n\n    const min = plotInstance.current.posToVal(coords.plotCanvas.x, 'x');\n\n    if (!min) {\n      return;\n    }\n\n    setSelection({\n      min,\n      max: min,\n      bbox: {\n        left: coords.plotCanvas.x,\n        top: 0,\n        height: bbox.height,\n        width: 0\n      }\n    });\n    setIsAddingAnnotation(true);\n  }, [bbox]);\n  return /*#__PURE__*/_jsxs(_Fragment, {\n    children: [isAddingAnnotation && selection && bbox && /*#__PURE__*/_jsx(AnnotationEditor, {\n      selection: selection,\n      onDismiss: clearSelection,\n      onSave: clearSelection,\n      data: data,\n      timeZone: timeZone,\n      style: {\n        position: 'absolute',\n        top: `${bbox.top}px`,\n        left: `${bbox.left}px`,\n        width: `${bbox.width}px`,\n        height: `${bbox.height}px`\n      }\n    }), children ? children({\n      startAnnotating\n    }) : null]\n  });\n};","map":{"version":3,"names":["React","useCallback","useLayoutEffect","useRef","useState","useMountedState","AnnotationEditor","AnnotationEditorPlugin","data","timeZone","config","children","plotInstance","bbox","setBbox","isAddingAnnotation","setIsAddingAnnotation","selection","setSelection","isMounted","clearSelection","current","setSelect","top","left","width","height","annotating","addHook","u","setSelectHooks","hooks","i","length","hook","args","rect","min","posToVal","select","max","setCursor","bind","mousedown","targ","handler","e","button","metaKey","ctrlKey","mouseup","cursor","window","devicePixelRatio","startAnnotating","coords","plotCanvas","x","position"],"sources":["/home/soula/grafana/public/app/plugins/panel/timeseries/plugins/AnnotationEditorPlugin.tsx"],"sourcesContent":["import React, { useCallback, useLayoutEffect, useRef, useState } from 'react';\nimport { useMountedState } from 'react-use';\nimport uPlot from 'uplot';\n\nimport { CartesianCoords2D, DataFrame, TimeZone } from '@grafana/data';\nimport { PlotSelection, UPlotConfigBuilder } from '@grafana/ui';\n\nimport { AnnotationEditor } from './annotations/AnnotationEditor';\n\ntype StartAnnotatingFn = (props: {\n  // pixel coordinates of the clicked point on the uPlot canvas\n  coords: { viewport: CartesianCoords2D; plotCanvas: CartesianCoords2D } | null;\n}) => void;\n\ninterface AnnotationEditorPluginProps {\n  data: DataFrame;\n  timeZone: TimeZone;\n  config: UPlotConfigBuilder;\n  children?: (props: { startAnnotating: StartAnnotatingFn }) => React.ReactNode;\n}\n\n/**\n * @alpha\n */\nexport const AnnotationEditorPlugin: React.FC<AnnotationEditorPluginProps> = ({ data, timeZone, config, children }) => {\n  const plotInstance = useRef<uPlot>();\n  const [bbox, setBbox] = useState<DOMRect>();\n  const [isAddingAnnotation, setIsAddingAnnotation] = useState(false);\n  const [selection, setSelection] = useState<PlotSelection | null>(null);\n  const isMounted = useMountedState();\n\n  const clearSelection = useCallback(() => {\n    setSelection(null);\n\n    if (plotInstance.current) {\n      plotInstance.current.setSelect({ top: 0, left: 0, width: 0, height: 0 });\n    }\n    setIsAddingAnnotation(false);\n  }, [setIsAddingAnnotation, setSelection]);\n\n  useLayoutEffect(() => {\n    let annotating = false;\n\n    config.addHook('init', (u) => {\n      plotInstance.current = u;\n      // Wrap all setSelect hooks to prevent them from firing if user is annotating\n      const setSelectHooks = u.hooks.setSelect;\n\n      if (setSelectHooks) {\n        for (let i = 0; i < setSelectHooks.length; i++) {\n          const hook = setSelectHooks[i];\n\n          if (hook !== setSelect) {\n            setSelectHooks[i] = (...args) => {\n              !annotating && hook!(...args);\n            };\n          }\n        }\n      }\n    });\n\n    // cache uPlot plotting area bounding box\n    config.addHook('syncRect', (u, rect) => {\n      if (!isMounted()) {\n        return;\n      }\n      setBbox(rect);\n    });\n\n    const setSelect = (u: uPlot) => {\n      if (annotating) {\n        setIsAddingAnnotation(true);\n        setSelection({\n          min: u.posToVal(u.select.left, 'x'),\n          max: u.posToVal(u.select.left + u.select.width, 'x'),\n          bbox: {\n            left: u.select.left,\n            top: 0,\n            height: u.select.height,\n            width: u.select.width,\n          },\n        });\n        annotating = false;\n      }\n    };\n\n    config.addHook('setSelect', setSelect);\n\n    config.setCursor({\n      bind: {\n        mousedown: (u, targ, handler) => (e) => {\n          annotating = e.button === 0 && (e.metaKey || e.ctrlKey);\n          handler(e);\n          return null;\n        },\n        mouseup: (u, targ, handler) => (e) => {\n          // uPlot will not fire setSelect hooks for 0-width && 0-height selections\n          // so we force it to fire on single-point clicks by mutating left & height\n          if (annotating && u.select.width === 0) {\n            u.select.left = u.cursor.left!;\n            u.select.height = u.bbox.height / window.devicePixelRatio;\n          }\n          handler(e);\n          return null;\n        },\n      },\n    });\n  }, [config, setBbox, isMounted]);\n\n  const startAnnotating = useCallback<StartAnnotatingFn>(\n    ({ coords }) => {\n      if (!plotInstance.current || !bbox || !coords) {\n        return;\n      }\n\n      const min = plotInstance.current.posToVal(coords.plotCanvas.x, 'x');\n\n      if (!min) {\n        return;\n      }\n\n      setSelection({\n        min,\n        max: min,\n        bbox: {\n          left: coords.plotCanvas.x,\n          top: 0,\n          height: bbox.height,\n          width: 0,\n        },\n      });\n      setIsAddingAnnotation(true);\n    },\n    [bbox]\n  );\n\n  return (\n    <>\n      {isAddingAnnotation && selection && bbox && (\n        <AnnotationEditor\n          selection={selection}\n          onDismiss={clearSelection}\n          onSave={clearSelection}\n          data={data}\n          timeZone={timeZone}\n          style={{\n            position: 'absolute',\n            top: `${bbox.top}px`,\n            left: `${bbox.left}px`,\n            width: `${bbox.width}px`,\n            height: `${bbox.height}px`,\n          }}\n        />\n      )}\n      {children ? children({ startAnnotating }) : null}\n    </>\n  );\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}