{"ast":null,"code":"function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport { clone, filter, find, findIndex, indexOf, map } from 'lodash';\nimport { PanelEvents } from '@grafana/data';\nimport appEvents from 'app/core/app_events';\nimport { QueryCtrl } from 'app/plugins/sdk';\nimport { ShowConfirmModalEvent } from 'app/types/events';\nimport { PostgresMetaQuery } from './meta_query';\nimport PostgresQueryModel from './postgres_query_model';\nimport sqlPart from './sql_part';\nconst defaultQuery = `SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n`;\nexport class PostgresQueryCtrl extends QueryCtrl {\n  /** @ngInject */\n  constructor($scope, $injector, templateSrv, uiSegmentSrv) {\n    super($scope, $injector);\n\n    _defineProperty(this, \"formats\", void 0);\n\n    _defineProperty(this, \"queryModel\", void 0);\n\n    _defineProperty(this, \"metaBuilder\", void 0);\n\n    _defineProperty(this, \"lastQueryMeta\", void 0);\n\n    _defineProperty(this, \"lastQueryError\", void 0);\n\n    _defineProperty(this, \"showHelp\", false);\n\n    _defineProperty(this, \"tableSegment\", void 0);\n\n    _defineProperty(this, \"whereAdd\", void 0);\n\n    _defineProperty(this, \"timeColumnSegment\", void 0);\n\n    _defineProperty(this, \"metricColumnSegment\", void 0);\n\n    _defineProperty(this, \"selectMenu\", []);\n\n    _defineProperty(this, \"selectParts\", [[]]);\n\n    _defineProperty(this, \"groupParts\", []);\n\n    _defineProperty(this, \"whereParts\", []);\n\n    _defineProperty(this, \"groupAdd\", void 0);\n\n    this.templateSrv = templateSrv;\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.target = this.target;\n    this.queryModel = new PostgresQueryModel(this.target, templateSrv, this.panel.scopedVars);\n    this.metaBuilder = new PostgresMetaQuery(this.target, this.queryModel);\n    this.updateProjection();\n    this.formats = [{\n      text: 'Time series',\n      value: 'time_series'\n    }, {\n      text: 'Table',\n      value: 'table'\n    }];\n\n    if (!this.target.rawSql) {\n      // special handling when in table panel\n      if (this.panelCtrl.panel.type === 'table') {\n        this.target.format = 'table';\n        this.target.rawSql = 'SELECT 1';\n        this.target.rawQuery = true;\n      } else {\n        this.target.rawSql = defaultQuery;\n        this.datasource.metricFindQuery(this.metaBuilder.findMetricTable()).then(result => {\n          if (result.length > 0) {\n            this.target.table = result[0].text;\n            let segment = this.uiSegmentSrv.newSegment(this.target.table);\n            this.tableSegment.html = segment.html;\n            this.tableSegment.value = segment.value;\n            this.target.timeColumn = result[1].text;\n            segment = this.uiSegmentSrv.newSegment(this.target.timeColumn);\n            this.timeColumnSegment.html = segment.html;\n            this.timeColumnSegment.value = segment.value;\n            this.target.timeColumnType = 'timestamp';\n            this.target.select = [[{\n              type: 'column',\n              params: [result[2].text]\n            }]];\n            this.updateProjection();\n            this.updateRawSqlAndRefresh();\n          }\n        });\n      }\n    }\n\n    if (!this.target.table) {\n      this.tableSegment = uiSegmentSrv.newSegment({\n        value: 'select table',\n        fake: true\n      });\n    } else {\n      this.tableSegment = uiSegmentSrv.newSegment(this.target.table);\n    }\n\n    this.timeColumnSegment = uiSegmentSrv.newSegment(this.target.timeColumn);\n    this.metricColumnSegment = uiSegmentSrv.newSegment(this.target.metricColumn);\n    this.buildSelectMenu();\n    this.whereAdd = this.uiSegmentSrv.newPlusButton();\n    this.groupAdd = this.uiSegmentSrv.newPlusButton();\n    this.panelCtrl.events.on(PanelEvents.dataReceived, this.onDataReceived.bind(this), $scope);\n    this.panelCtrl.events.on(PanelEvents.dataError, this.onDataError.bind(this), $scope);\n  }\n\n  updateRawSqlAndRefresh() {\n    if (!this.target.rawQuery) {\n      this.target.rawSql = this.queryModel.buildQuery();\n    }\n\n    this.panelCtrl.refresh();\n  }\n\n  timescaleAggCheck() {\n    const aggIndex = this.findAggregateIndex(this.selectParts[0]); // add or remove TimescaleDB aggregate functions as needed\n\n    if (aggIndex !== -1) {\n      const baseOpts = this.selectParts[0][aggIndex].def.params[0].baseOptions;\n      const timescaleOpts = baseOpts.concat(this.selectParts[0][aggIndex].def.params[0].timescaleOptions);\n\n      if (this.datasource.jsonData.timescaledb === true) {\n        this.selectParts[0][aggIndex].def.params[0].options = timescaleOpts;\n      } else {\n        this.selectParts[0][aggIndex].def.params[0].options = baseOpts;\n      }\n    }\n  }\n\n  updateProjection() {\n    this.selectParts = map(this.target.select, parts => {\n      return map(parts, sqlPart.create).filter(n => n);\n    });\n    this.timescaleAggCheck();\n    this.whereParts = map(this.target.where, sqlPart.create).filter(n => n);\n    this.groupParts = map(this.target.group, sqlPart.create).filter(n => n);\n  }\n\n  updatePersistedParts() {\n    this.target.select = map(this.selectParts, selectParts => {\n      return map(selectParts, part => {\n        return {\n          type: part.def.type,\n          datatype: part.datatype,\n          params: part.params\n        };\n      });\n    });\n    this.timescaleAggCheck();\n    this.target.where = map(this.whereParts, part => {\n      return {\n        type: part.def.type,\n        datatype: part.datatype,\n        name: part.name,\n        params: part.params\n      };\n    });\n    this.target.group = map(this.groupParts, part => {\n      return {\n        type: part.def.type,\n        datatype: part.datatype,\n        params: part.params\n      };\n    });\n  }\n\n  buildSelectMenu() {\n    this.selectMenu = [];\n    const aggregates = {\n      text: 'Aggregate Functions',\n      value: 'aggregate',\n      submenu: [{\n        text: 'Average',\n        value: 'avg'\n      }, {\n        text: 'Count',\n        value: 'count'\n      }, {\n        text: 'Maximum',\n        value: 'max'\n      }, {\n        text: 'Minimum',\n        value: 'min'\n      }, {\n        text: 'Sum',\n        value: 'sum'\n      }, {\n        text: 'Standard deviation',\n        value: 'stddev'\n      }, {\n        text: 'Variance',\n        value: 'variance'\n      }]\n    }; // first and last aggregate are timescaledb specific\n\n    if (this.datasource.jsonData.timescaledb === true) {\n      aggregates.submenu.push({\n        text: 'First',\n        value: 'first'\n      });\n      aggregates.submenu.push({\n        text: 'Last',\n        value: 'last'\n      });\n    }\n\n    this.selectMenu.push(aggregates); // ordered set aggregates require postgres 9.4+\n\n    if (this.datasource.jsonData.postgresVersion >= 904) {\n      const aggregates2 = {\n        text: 'Ordered-Set Aggregate Functions',\n        value: 'percentile',\n        submenu: [{\n          text: 'Percentile (continuous)',\n          value: 'percentile_cont'\n        }, {\n          text: 'Percentile (discrete)',\n          value: 'percentile_disc'\n        }]\n      };\n      this.selectMenu.push(aggregates2);\n    }\n\n    const windows = {\n      text: 'Window Functions',\n      value: 'window',\n      submenu: [{\n        text: 'Delta',\n        value: 'delta'\n      }, {\n        text: 'Increase',\n        value: 'increase'\n      }, {\n        text: 'Rate',\n        value: 'rate'\n      }, {\n        text: 'Sum',\n        value: 'sum'\n      }, {\n        text: 'Moving Average',\n        value: 'avg',\n        type: 'moving_window'\n      }]\n    };\n    this.selectMenu.push(windows);\n    this.selectMenu.push({\n      text: 'Alias',\n      value: 'alias'\n    });\n    this.selectMenu.push({\n      text: 'Column',\n      value: 'column'\n    });\n  }\n\n  toggleEditorMode() {\n    if (this.target.rawQuery) {\n      appEvents.publish(new ShowConfirmModalEvent({\n        title: 'Warning',\n        text2: 'Switching to query builder may overwrite your raw SQL.',\n        icon: 'exclamation-triangle',\n        yesText: 'Switch',\n        onConfirm: () => {\n          // This could be called from React, so wrap in $evalAsync.\n          // Will then either run as part of the current digest cycle or trigger a new one.\n          this.$scope.$evalAsync(() => {\n            this.target.rawQuery = !this.target.rawQuery;\n          });\n        }\n      }));\n    } else {\n      // This could be called from React, so wrap in $evalAsync.\n      // Will then either run as part of the current digest cycle or trigger a new one.\n      this.$scope.$evalAsync(() => {\n        this.target.rawQuery = !this.target.rawQuery;\n      });\n    }\n  }\n\n  resetPlusButton(button) {\n    const plusButton = this.uiSegmentSrv.newPlusButton();\n    button.html = plusButton.html;\n    button.value = plusButton.value;\n    button.type = plusButton.type;\n    button.fake = plusButton.fake;\n  }\n\n  getTableSegments() {\n    return this.datasource.metricFindQuery(this.metaBuilder.buildTableQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));\n  }\n\n  tableChanged() {\n    this.target.table = this.tableSegment.value;\n    this.target.where = [];\n    this.target.group = [];\n    this.updateProjection();\n    const segment = this.uiSegmentSrv.newSegment('none');\n    this.metricColumnSegment.html = segment.html;\n    this.metricColumnSegment.value = segment.value;\n    this.target.metricColumn = 'none';\n    const task1 = this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery('time')).then(result => {\n      // check if time column is still valid\n      if (result.length > 0 && !find(result, r => r.text === this.target.timeColumn)) {\n        const segment = this.uiSegmentSrv.newSegment(result[0].text);\n        this.timeColumnSegment.html = segment.html;\n        this.timeColumnSegment.value = segment.value;\n      }\n\n      return this.timeColumnChanged(false);\n    });\n    const task2 = this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery('value')).then(result => {\n      if (result.length > 0) {\n        this.target.select = [[{\n          type: 'column',\n          params: [result[0].text]\n        }]];\n        this.updateProjection();\n      }\n    });\n    Promise.all([task1, task2]).then(() => {\n      this.updateRawSqlAndRefresh();\n    });\n  }\n\n  getTimeColumnSegments() {\n    return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery('time')).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));\n  }\n\n  timeColumnChanged(refresh) {\n    this.target.timeColumn = this.timeColumnSegment.value;\n    return this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(this.target.timeColumn)).then(result => {\n      if (result.length === 1) {\n        if (this.target.timeColumnType !== result[0].text) {\n          this.target.timeColumnType = result[0].text;\n        }\n\n        let partModel;\n\n        if (this.queryModel.hasUnixEpochTimecolumn()) {\n          partModel = sqlPart.create({\n            type: 'macro',\n            name: '$__unixEpochFilter',\n            params: []\n          });\n        } else {\n          partModel = sqlPart.create({\n            type: 'macro',\n            name: '$__timeFilter',\n            params: []\n          });\n        }\n\n        if (this.whereParts.length >= 1 && this.whereParts[0].def.type === 'macro') {\n          // replace current macro\n          this.whereParts[0] = partModel;\n        } else {\n          this.whereParts.splice(0, 0, partModel);\n        }\n      }\n\n      this.updatePersistedParts();\n\n      if (refresh !== false) {\n        this.updateRawSqlAndRefresh();\n      }\n    });\n  }\n\n  getMetricColumnSegments() {\n    return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery('metric')).then(this.transformToSegments({\n      addNone: true\n    })).catch(this.handleQueryError.bind(this));\n  }\n\n  metricColumnChanged() {\n    this.target.metricColumn = this.metricColumnSegment.value;\n    this.updateRawSqlAndRefresh();\n  }\n\n  onDataReceived(dataList) {\n    var _dataList$;\n\n    this.lastQueryError = undefined;\n    this.lastQueryMeta = (_dataList$ = dataList[0]) === null || _dataList$ === void 0 ? void 0 : _dataList$.meta;\n  }\n\n  onDataError(err) {\n    if (err.data && err.data.results) {\n      const queryRes = err.data.results[this.target.refId];\n\n      if (queryRes) {\n        this.lastQueryError = queryRes.error;\n      }\n    }\n  }\n\n  transformToSegments(config) {\n    return results => {\n      const segments = map(results, segment => {\n        return this.uiSegmentSrv.newSegment({\n          value: segment.text,\n          expandable: segment.expandable\n        });\n      });\n\n      if (config.addTemplateVars) {\n        for (const variable of this.templateSrv.getVariables()) {\n          let value;\n          value = '$' + variable.name;\n\n          if (config.templateQuoter && variable.multi === false) {\n            value = config.templateQuoter(value);\n          }\n\n          segments.unshift(this.uiSegmentSrv.newSegment({\n            type: 'template',\n            value: value,\n            expandable: true\n          }));\n        }\n      }\n\n      if (config.addNone) {\n        segments.unshift(this.uiSegmentSrv.newSegment({\n          type: 'template',\n          value: 'none',\n          expandable: true\n        }));\n      }\n\n      return segments;\n    };\n  }\n\n  findAggregateIndex(selectParts) {\n    return findIndex(selectParts, p => p.def.type === 'aggregate' || p.def.type === 'percentile');\n  }\n\n  findWindowIndex(selectParts) {\n    return findIndex(selectParts, p => p.def.type === 'window' || p.def.type === 'moving_window');\n  }\n\n  addSelectPart(selectParts, item, subItem) {\n    let partType = item.value;\n\n    if (subItem && subItem.type) {\n      partType = subItem.type;\n    }\n\n    let partModel = sqlPart.create({\n      type: partType\n    });\n\n    if (subItem) {\n      partModel.params[0] = subItem.value;\n    }\n\n    let addAlias = false;\n\n    switch (partType) {\n      case 'column':\n        const parts = map(selectParts, part => {\n          return sqlPart.create({\n            type: part.def.type,\n            params: clone(part.params)\n          });\n        });\n        this.selectParts.push(parts);\n        break;\n\n      case 'percentile':\n      case 'aggregate':\n        // add group by if no group by yet\n        if (this.target.group.length === 0) {\n          this.addGroup('time', '$__interval');\n        }\n\n        const aggIndex = this.findAggregateIndex(selectParts);\n\n        if (aggIndex !== -1) {\n          // replace current aggregation\n          selectParts[aggIndex] = partModel;\n        } else {\n          selectParts.splice(1, 0, partModel);\n        }\n\n        if (!find(selectParts, p => p.def.type === 'alias')) {\n          addAlias = true;\n        }\n\n        break;\n\n      case 'moving_window':\n      case 'window':\n        const windowIndex = this.findWindowIndex(selectParts);\n\n        if (windowIndex !== -1) {\n          // replace current window function\n          selectParts[windowIndex] = partModel;\n        } else {\n          const aggIndex = this.findAggregateIndex(selectParts);\n\n          if (aggIndex !== -1) {\n            selectParts.splice(aggIndex + 1, 0, partModel);\n          } else {\n            selectParts.splice(1, 0, partModel);\n          }\n        }\n\n        if (!find(selectParts, p => p.def.type === 'alias')) {\n          addAlias = true;\n        }\n\n        break;\n\n      case 'alias':\n        addAlias = true;\n        break;\n    }\n\n    if (addAlias) {\n      // set initial alias name to column name\n      partModel = sqlPart.create({\n        type: 'alias',\n        params: [selectParts[0].params[0].replace(/\"/g, '')]\n      });\n\n      if (selectParts[selectParts.length - 1].def.type === 'alias') {\n        selectParts[selectParts.length - 1] = partModel;\n      } else {\n        selectParts.push(partModel);\n      }\n    }\n\n    this.updatePersistedParts();\n    this.updateRawSqlAndRefresh();\n  }\n\n  removeSelectPart(selectParts, part) {\n    if (part.def.type === 'column') {\n      // remove all parts of column unless its last column\n      if (this.selectParts.length > 1) {\n        const modelsIndex = indexOf(this.selectParts, selectParts);\n        this.selectParts.splice(modelsIndex, 1);\n      }\n    } else {\n      const partIndex = indexOf(selectParts, part);\n      selectParts.splice(partIndex, 1);\n    }\n\n    this.updatePersistedParts();\n  }\n\n  handleSelectPartEvent(selectParts, part, evt) {\n    switch (evt.name) {\n      case 'get-param-options':\n        {\n          switch (part.def.type) {\n            case 'aggregate':\n              return this.datasource.metricFindQuery(this.metaBuilder.buildAggregateQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));\n\n            case 'column':\n              return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery('value')).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));\n          }\n        }\n\n      case 'part-param-changed':\n        {\n          this.updatePersistedParts();\n          this.updateRawSqlAndRefresh();\n          break;\n        }\n\n      case 'action':\n        {\n          this.removeSelectPart(selectParts, part);\n          this.updateRawSqlAndRefresh();\n          break;\n        }\n\n      case 'get-part-actions':\n        {\n          return Promise.resolve([{\n            text: 'Remove',\n            value: 'remove-part'\n          }]);\n        }\n    }\n  }\n\n  handleGroupPartEvent(part, index, evt) {\n    switch (evt.name) {\n      case 'get-param-options':\n        {\n          return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));\n        }\n\n      case 'part-param-changed':\n        {\n          this.updatePersistedParts();\n          this.updateRawSqlAndRefresh();\n          break;\n        }\n\n      case 'action':\n        {\n          this.removeGroup(part, index);\n          this.updateRawSqlAndRefresh();\n          break;\n        }\n\n      case 'get-part-actions':\n        {\n          return Promise.resolve([{\n            text: 'Remove',\n            value: 'remove-part'\n          }]);\n        }\n    }\n  }\n\n  addGroup(partType, value) {\n    let params = [value];\n\n    if (partType === 'time') {\n      params = ['$__interval', 'none'];\n    }\n\n    const partModel = sqlPart.create({\n      type: partType,\n      params: params\n    });\n\n    if (partType === 'time') {\n      // put timeGroup at start\n      this.groupParts.splice(0, 0, partModel);\n    } else {\n      this.groupParts.push(partModel);\n    } // add aggregates when adding group by\n\n\n    for (const selectParts of this.selectParts) {\n      if (!selectParts.some(part => part.def.type === 'aggregate')) {\n        const aggregate = sqlPart.create({\n          type: 'aggregate',\n          params: ['avg']\n        });\n        selectParts.splice(1, 0, aggregate);\n\n        if (!selectParts.some(part => part.def.type === 'alias')) {\n          const alias = sqlPart.create({\n            type: 'alias',\n            params: [selectParts[0].part.params[0]]\n          });\n          selectParts.push(alias);\n        }\n      }\n    }\n\n    this.updatePersistedParts();\n  }\n\n  removeGroup(part, index) {\n    if (part.def.type === 'time') {\n      // remove aggregations\n      this.selectParts = map(this.selectParts, s => {\n        return filter(s, part => {\n          if (part.def.type === 'aggregate' || part.def.type === 'percentile') {\n            return false;\n          }\n\n          return true;\n        });\n      });\n    }\n\n    this.groupParts.splice(index, 1);\n    this.updatePersistedParts();\n  }\n\n  handleWherePartEvent(whereParts, part, evt, index) {\n    switch (evt.name) {\n      case 'get-param-options':\n        {\n          switch (evt.param.name) {\n            case 'left':\n              return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));\n\n            case 'right':\n              if (['int4', 'int8', 'float4', 'float8', 'timestamp', 'timestamptz'].indexOf(part.datatype) > -1) {\n                // don't do value lookups for numerical fields\n                return Promise.resolve([]);\n              } else {\n                return this.datasource.metricFindQuery(this.metaBuilder.buildValueQuery(part.params[0])).then(this.transformToSegments({\n                  addTemplateVars: true,\n                  templateQuoter: v => {\n                    return this.queryModel.quoteLiteral(v);\n                  }\n                })).catch(this.handleQueryError.bind(this));\n              }\n\n            case 'op':\n              return Promise.resolve(this.uiSegmentSrv.newOperators(this.metaBuilder.getOperators(part.datatype)));\n\n            default:\n              return Promise.resolve([]);\n          }\n        }\n\n      case 'part-param-changed':\n        {\n          this.updatePersistedParts();\n          this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(part.params[0])).then(d => {\n            if (d.length === 1) {\n              part.datatype = d[0].text;\n            }\n          });\n          this.updateRawSqlAndRefresh();\n          break;\n        }\n\n      case 'action':\n        {\n          // remove element\n          whereParts.splice(index, 1);\n          this.updatePersistedParts();\n          this.updateRawSqlAndRefresh();\n          break;\n        }\n\n      case 'get-part-actions':\n        {\n          return Promise.resolve([{\n            text: 'Remove',\n            value: 'remove-part'\n          }]);\n        }\n    }\n  }\n\n  getWhereOptions() {\n    const options = [];\n\n    if (this.queryModel.hasUnixEpochTimecolumn()) {\n      options.push(this.uiSegmentSrv.newSegment({\n        type: 'macro',\n        value: '$__unixEpochFilter'\n      }));\n    } else {\n      options.push(this.uiSegmentSrv.newSegment({\n        type: 'macro',\n        value: '$__timeFilter'\n      }));\n    }\n\n    options.push(this.uiSegmentSrv.newSegment({\n      type: 'expression',\n      value: 'Expression'\n    }));\n    return Promise.resolve(options);\n  }\n\n  addWhereAction(part, index) {\n    switch (this.whereAdd.type) {\n      case 'macro':\n        {\n          const partModel = sqlPart.create({\n            type: 'macro',\n            name: this.whereAdd.value,\n            params: []\n          });\n\n          if (this.whereParts.length >= 1 && this.whereParts[0].def.type === 'macro') {\n            // replace current macro\n            this.whereParts[0] = partModel;\n          } else {\n            this.whereParts.splice(0, 0, partModel);\n          }\n\n          break;\n        }\n\n      default:\n        {\n          this.whereParts.push(sqlPart.create({\n            type: 'expression',\n            params: ['value', '=', 'value']\n          }));\n        }\n    }\n\n    this.updatePersistedParts();\n    this.resetPlusButton(this.whereAdd);\n    this.updateRawSqlAndRefresh();\n  }\n\n  getGroupOptions() {\n    return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery('group')).then(tags => {\n      const options = [];\n\n      if (!this.queryModel.hasTimeGroup()) {\n        options.push(this.uiSegmentSrv.newSegment({\n          type: 'time',\n          value: 'time($__interval,none)'\n        }));\n      }\n\n      for (const tag of tags) {\n        options.push(this.uiSegmentSrv.newSegment({\n          type: 'column',\n          value: tag.text\n        }));\n      }\n\n      return options;\n    }).catch(this.handleQueryError.bind(this));\n  }\n\n  addGroupAction() {\n    this.addGroup(this.groupAdd.type, this.groupAdd.value);\n    this.resetPlusButton(this.groupAdd);\n    this.updateRawSqlAndRefresh();\n  }\n\n  handleQueryError(err) {\n    this.error = err.message || 'Failed to issue metric query';\n    return [];\n  }\n\n}\nPostgresQueryCtrl.$inject = [\"$scope\", \"$injector\", \"templateSrv\", \"uiSegmentSrv\"];\n\n_defineProperty(PostgresQueryCtrl, \"templateUrl\", 'partials/query.editor.html');","map":{"version":3,"names":["clone","filter","find","findIndex","indexOf","map","PanelEvents","appEvents","QueryCtrl","ShowConfirmModalEvent","PostgresMetaQuery","PostgresQueryModel","sqlPart","defaultQuery","PostgresQueryCtrl","constructor","$scope","$injector","templateSrv","uiSegmentSrv","target","queryModel","panel","scopedVars","metaBuilder","updateProjection","formats","text","value","rawSql","panelCtrl","type","format","rawQuery","datasource","metricFindQuery","findMetricTable","then","result","length","table","segment","newSegment","tableSegment","html","timeColumn","timeColumnSegment","timeColumnType","select","params","updateRawSqlAndRefresh","fake","metricColumnSegment","metricColumn","buildSelectMenu","whereAdd","newPlusButton","groupAdd","events","on","dataReceived","onDataReceived","bind","dataError","onDataError","buildQuery","refresh","timescaleAggCheck","aggIndex","findAggregateIndex","selectParts","baseOpts","def","baseOptions","timescaleOpts","concat","timescaleOptions","jsonData","timescaledb","options","parts","create","n","whereParts","where","groupParts","group","updatePersistedParts","part","datatype","name","selectMenu","aggregates","submenu","push","postgresVersion","aggregates2","windows","toggleEditorMode","publish","title","text2","icon","yesText","onConfirm","$evalAsync","resetPlusButton","button","plusButton","getTableSegments","buildTableQuery","transformToSegments","catch","handleQueryError","tableChanged","task1","buildColumnQuery","r","timeColumnChanged","task2","Promise","all","getTimeColumnSegments","buildDatatypeQuery","partModel","hasUnixEpochTimecolumn","splice","getMetricColumnSegments","addNone","metricColumnChanged","dataList","lastQueryError","undefined","lastQueryMeta","meta","err","data","results","queryRes","refId","error","config","segments","expandable","addTemplateVars","variable","getVariables","templateQuoter","multi","unshift","p","findWindowIndex","addSelectPart","item","subItem","partType","addAlias","addGroup","windowIndex","replace","removeSelectPart","modelsIndex","partIndex","handleSelectPartEvent","evt","buildAggregateQuery","resolve","handleGroupPartEvent","index","removeGroup","some","aggregate","alias","s","handleWherePartEvent","param","buildValueQuery","v","quoteLiteral","newOperators","getOperators","d","getWhereOptions","addWhereAction","getGroupOptions","tags","hasTimeGroup","tag","addGroupAction","message"],"sources":["/home/soula/grafana/public/app/plugins/datasource/postgres/query_ctrl.ts"],"sourcesContent":["import { auto } from 'angular';\nimport { clone, filter, find, findIndex, indexOf, map } from 'lodash';\n\nimport { PanelEvents, QueryResultMeta } from '@grafana/data';\nimport { TemplateSrv } from '@grafana/runtime';\nimport { SqlPart } from 'app/angular/components/sql_part/sql_part';\nimport appEvents from 'app/core/app_events';\nimport { VariableWithMultiSupport } from 'app/features/variables/types';\nimport { QueryCtrl } from 'app/plugins/sdk';\nimport { ShowConfirmModalEvent } from 'app/types/events';\n\nimport { PostgresMetaQuery } from './meta_query';\nimport PostgresQueryModel from './postgres_query_model';\nimport sqlPart from './sql_part';\n\nconst defaultQuery = `SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n`;\n\nexport class PostgresQueryCtrl extends QueryCtrl {\n  static templateUrl = 'partials/query.editor.html';\n\n  formats: any[];\n  queryModel: PostgresQueryModel;\n  metaBuilder: PostgresMetaQuery;\n  lastQueryMeta?: QueryResultMeta;\n  lastQueryError?: string;\n  showHelp = false;\n  tableSegment: any;\n  whereAdd: any;\n  timeColumnSegment: any;\n  metricColumnSegment: any;\n  selectMenu: any[] = [];\n  selectParts: SqlPart[][] = [[]];\n  groupParts: SqlPart[] = [];\n  whereParts: SqlPart[] = [];\n  groupAdd: any;\n\n  /** @ngInject */\n  constructor(\n    $scope: any,\n    $injector: auto.IInjectorService,\n    private templateSrv: TemplateSrv,\n    private uiSegmentSrv: any\n  ) {\n    super($scope, $injector);\n    this.target = this.target;\n    this.queryModel = new PostgresQueryModel(this.target, templateSrv, this.panel.scopedVars);\n    this.metaBuilder = new PostgresMetaQuery(this.target, this.queryModel);\n    this.updateProjection();\n\n    this.formats = [\n      { text: 'Time series', value: 'time_series' },\n      { text: 'Table', value: 'table' },\n    ];\n\n    if (!this.target.rawSql) {\n      // special handling when in table panel\n      if (this.panelCtrl.panel.type === 'table') {\n        this.target.format = 'table';\n        this.target.rawSql = 'SELECT 1';\n        this.target.rawQuery = true;\n      } else {\n        this.target.rawSql = defaultQuery;\n        this.datasource.metricFindQuery(this.metaBuilder.findMetricTable()).then((result: any) => {\n          if (result.length > 0) {\n            this.target.table = result[0].text;\n            let segment = this.uiSegmentSrv.newSegment(this.target.table);\n            this.tableSegment.html = segment.html;\n            this.tableSegment.value = segment.value;\n\n            this.target.timeColumn = result[1].text;\n            segment = this.uiSegmentSrv.newSegment(this.target.timeColumn);\n            this.timeColumnSegment.html = segment.html;\n            this.timeColumnSegment.value = segment.value;\n\n            this.target.timeColumnType = 'timestamp';\n            this.target.select = [[{ type: 'column', params: [result[2].text] }]];\n            this.updateProjection();\n            this.updateRawSqlAndRefresh();\n          }\n        });\n      }\n    }\n\n    if (!this.target.table) {\n      this.tableSegment = uiSegmentSrv.newSegment({ value: 'select table', fake: true });\n    } else {\n      this.tableSegment = uiSegmentSrv.newSegment(this.target.table);\n    }\n\n    this.timeColumnSegment = uiSegmentSrv.newSegment(this.target.timeColumn);\n    this.metricColumnSegment = uiSegmentSrv.newSegment(this.target.metricColumn);\n\n    this.buildSelectMenu();\n    this.whereAdd = this.uiSegmentSrv.newPlusButton();\n    this.groupAdd = this.uiSegmentSrv.newPlusButton();\n\n    this.panelCtrl.events.on(PanelEvents.dataReceived, this.onDataReceived.bind(this), $scope);\n    this.panelCtrl.events.on(PanelEvents.dataError, this.onDataError.bind(this), $scope);\n  }\n\n  updateRawSqlAndRefresh() {\n    if (!this.target.rawQuery) {\n      this.target.rawSql = this.queryModel.buildQuery();\n    }\n\n    this.panelCtrl.refresh();\n  }\n\n  timescaleAggCheck() {\n    const aggIndex = this.findAggregateIndex(this.selectParts[0]);\n\n    // add or remove TimescaleDB aggregate functions as needed\n    if (aggIndex !== -1) {\n      const baseOpts = this.selectParts[0][aggIndex].def.params[0].baseOptions;\n      const timescaleOpts = baseOpts.concat(this.selectParts[0][aggIndex].def.params[0].timescaleOptions);\n\n      if (this.datasource.jsonData.timescaledb === true) {\n        this.selectParts[0][aggIndex].def.params[0].options = timescaleOpts;\n      } else {\n        this.selectParts[0][aggIndex].def.params[0].options = baseOpts;\n      }\n    }\n  }\n\n  updateProjection() {\n    this.selectParts = map(this.target.select, (parts: any) => {\n      return map(parts, sqlPart.create).filter((n) => n);\n    });\n    this.timescaleAggCheck();\n    this.whereParts = map(this.target.where, sqlPart.create).filter((n) => n);\n    this.groupParts = map(this.target.group, sqlPart.create).filter((n) => n);\n  }\n\n  updatePersistedParts() {\n    this.target.select = map(this.selectParts, (selectParts) => {\n      return map(selectParts, (part: any) => {\n        return { type: part.def.type, datatype: part.datatype, params: part.params };\n      });\n    });\n    this.timescaleAggCheck();\n    this.target.where = map(this.whereParts, (part: any) => {\n      return { type: part.def.type, datatype: part.datatype, name: part.name, params: part.params };\n    });\n    this.target.group = map(this.groupParts, (part: any) => {\n      return { type: part.def.type, datatype: part.datatype, params: part.params };\n    });\n  }\n\n  buildSelectMenu() {\n    this.selectMenu = [];\n    const aggregates = {\n      text: 'Aggregate Functions',\n      value: 'aggregate',\n      submenu: [\n        { text: 'Average', value: 'avg' },\n        { text: 'Count', value: 'count' },\n        { text: 'Maximum', value: 'max' },\n        { text: 'Minimum', value: 'min' },\n        { text: 'Sum', value: 'sum' },\n        { text: 'Standard deviation', value: 'stddev' },\n        { text: 'Variance', value: 'variance' },\n      ],\n    };\n\n    // first and last aggregate are timescaledb specific\n    if (this.datasource.jsonData.timescaledb === true) {\n      aggregates.submenu.push({ text: 'First', value: 'first' });\n      aggregates.submenu.push({ text: 'Last', value: 'last' });\n    }\n\n    this.selectMenu.push(aggregates);\n\n    // ordered set aggregates require postgres 9.4+\n    if (this.datasource.jsonData.postgresVersion >= 904) {\n      const aggregates2 = {\n        text: 'Ordered-Set Aggregate Functions',\n        value: 'percentile',\n        submenu: [\n          { text: 'Percentile (continuous)', value: 'percentile_cont' },\n          { text: 'Percentile (discrete)', value: 'percentile_disc' },\n        ],\n      };\n      this.selectMenu.push(aggregates2);\n    }\n\n    const windows = {\n      text: 'Window Functions',\n      value: 'window',\n      submenu: [\n        { text: 'Delta', value: 'delta' },\n        { text: 'Increase', value: 'increase' },\n        { text: 'Rate', value: 'rate' },\n        { text: 'Sum', value: 'sum' },\n        { text: 'Moving Average', value: 'avg', type: 'moving_window' },\n      ],\n    };\n    this.selectMenu.push(windows);\n\n    this.selectMenu.push({ text: 'Alias', value: 'alias' });\n    this.selectMenu.push({ text: 'Column', value: 'column' });\n  }\n\n  toggleEditorMode() {\n    if (this.target.rawQuery) {\n      appEvents.publish(\n        new ShowConfirmModalEvent({\n          title: 'Warning',\n          text2: 'Switching to query builder may overwrite your raw SQL.',\n          icon: 'exclamation-triangle',\n          yesText: 'Switch',\n          onConfirm: () => {\n            // This could be called from React, so wrap in $evalAsync.\n            // Will then either run as part of the current digest cycle or trigger a new one.\n            this.$scope.$evalAsync(() => {\n              this.target.rawQuery = !this.target.rawQuery;\n            });\n          },\n        })\n      );\n    } else {\n      // This could be called from React, so wrap in $evalAsync.\n      // Will then either run as part of the current digest cycle or trigger a new one.\n      this.$scope.$evalAsync(() => {\n        this.target.rawQuery = !this.target.rawQuery;\n      });\n    }\n  }\n\n  resetPlusButton(button: { html: any; value: any; type: any; fake: any }) {\n    const plusButton = this.uiSegmentSrv.newPlusButton();\n    button.html = plusButton.html;\n    button.value = plusButton.value;\n    button.type = plusButton.type;\n    button.fake = plusButton.fake;\n  }\n\n  getTableSegments() {\n    return this.datasource\n      .metricFindQuery(this.metaBuilder.buildTableQuery())\n      .then(this.transformToSegments({}))\n      .catch(this.handleQueryError.bind(this));\n  }\n\n  tableChanged() {\n    this.target.table = this.tableSegment.value;\n    this.target.where = [];\n    this.target.group = [];\n    this.updateProjection();\n\n    const segment = this.uiSegmentSrv.newSegment('none');\n    this.metricColumnSegment.html = segment.html;\n    this.metricColumnSegment.value = segment.value;\n    this.target.metricColumn = 'none';\n\n    const task1 = this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery('time')).then((result: any) => {\n      // check if time column is still valid\n      if (result.length > 0 && !find(result, (r: any) => r.text === this.target.timeColumn)) {\n        const segment = this.uiSegmentSrv.newSegment(result[0].text);\n        this.timeColumnSegment.html = segment.html;\n        this.timeColumnSegment.value = segment.value;\n      }\n      return this.timeColumnChanged(false);\n    });\n    const task2 = this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery('value')).then((result: any) => {\n      if (result.length > 0) {\n        this.target.select = [[{ type: 'column', params: [result[0].text] }]];\n        this.updateProjection();\n      }\n    });\n\n    Promise.all([task1, task2]).then(() => {\n      this.updateRawSqlAndRefresh();\n    });\n  }\n\n  getTimeColumnSegments() {\n    return this.datasource\n      .metricFindQuery(this.metaBuilder.buildColumnQuery('time'))\n      .then(this.transformToSegments({}))\n      .catch(this.handleQueryError.bind(this));\n  }\n\n  timeColumnChanged(refresh?: boolean) {\n    this.target.timeColumn = this.timeColumnSegment.value;\n    return this.datasource\n      .metricFindQuery(this.metaBuilder.buildDatatypeQuery(this.target.timeColumn))\n      .then((result: any) => {\n        if (result.length === 1) {\n          if (this.target.timeColumnType !== result[0].text) {\n            this.target.timeColumnType = result[0].text;\n          }\n          let partModel;\n          if (this.queryModel.hasUnixEpochTimecolumn()) {\n            partModel = sqlPart.create({ type: 'macro', name: '$__unixEpochFilter', params: [] });\n          } else {\n            partModel = sqlPart.create({ type: 'macro', name: '$__timeFilter', params: [] });\n          }\n\n          if (this.whereParts.length >= 1 && this.whereParts[0].def.type === 'macro') {\n            // replace current macro\n            this.whereParts[0] = partModel;\n          } else {\n            this.whereParts.splice(0, 0, partModel);\n          }\n        }\n\n        this.updatePersistedParts();\n        if (refresh !== false) {\n          this.updateRawSqlAndRefresh();\n        }\n      });\n  }\n\n  getMetricColumnSegments() {\n    return this.datasource\n      .metricFindQuery(this.metaBuilder.buildColumnQuery('metric'))\n      .then(this.transformToSegments({ addNone: true }))\n      .catch(this.handleQueryError.bind(this));\n  }\n\n  metricColumnChanged() {\n    this.target.metricColumn = this.metricColumnSegment.value;\n    this.updateRawSqlAndRefresh();\n  }\n\n  onDataReceived(dataList: any) {\n    this.lastQueryError = undefined;\n    this.lastQueryMeta = dataList[0]?.meta;\n  }\n\n  onDataError(err: any) {\n    if (err.data && err.data.results) {\n      const queryRes = err.data.results[this.target.refId];\n      if (queryRes) {\n        this.lastQueryError = queryRes.error;\n      }\n    }\n  }\n\n  transformToSegments(config: { addNone?: any; addTemplateVars?: any; templateQuoter?: any }) {\n    return (results: any) => {\n      const segments = map(results, (segment) => {\n        return this.uiSegmentSrv.newSegment({\n          value: segment.text,\n          expandable: segment.expandable,\n        });\n      });\n\n      if (config.addTemplateVars) {\n        for (const variable of this.templateSrv.getVariables()) {\n          let value;\n          value = '$' + variable.name;\n          if (config.templateQuoter && (variable as unknown as VariableWithMultiSupport).multi === false) {\n            value = config.templateQuoter(value);\n          }\n\n          segments.unshift(\n            this.uiSegmentSrv.newSegment({\n              type: 'template',\n              value: value,\n              expandable: true,\n            })\n          );\n        }\n      }\n\n      if (config.addNone) {\n        segments.unshift(this.uiSegmentSrv.newSegment({ type: 'template', value: 'none', expandable: true }));\n      }\n\n      return segments;\n    };\n  }\n\n  findAggregateIndex(selectParts: any) {\n    return findIndex(selectParts, (p: any) => p.def.type === 'aggregate' || p.def.type === 'percentile');\n  }\n\n  findWindowIndex(selectParts: any) {\n    return findIndex(selectParts, (p: any) => p.def.type === 'window' || p.def.type === 'moving_window');\n  }\n\n  addSelectPart(selectParts: any[], item: { value: any }, subItem: { type: any; value: any }) {\n    let partType = item.value;\n    if (subItem && subItem.type) {\n      partType = subItem.type;\n    }\n    let partModel = sqlPart.create({ type: partType });\n    if (subItem) {\n      partModel.params[0] = subItem.value;\n    }\n    let addAlias = false;\n\n    switch (partType) {\n      case 'column':\n        const parts = map(selectParts, (part: any) => {\n          return sqlPart.create({ type: part.def.type, params: clone(part.params) });\n        });\n        this.selectParts.push(parts);\n        break;\n      case 'percentile':\n      case 'aggregate':\n        // add group by if no group by yet\n        if (this.target.group.length === 0) {\n          this.addGroup('time', '$__interval');\n        }\n        const aggIndex = this.findAggregateIndex(selectParts);\n        if (aggIndex !== -1) {\n          // replace current aggregation\n          selectParts[aggIndex] = partModel;\n        } else {\n          selectParts.splice(1, 0, partModel);\n        }\n        if (!find(selectParts, (p: any) => p.def.type === 'alias')) {\n          addAlias = true;\n        }\n        break;\n      case 'moving_window':\n      case 'window':\n        const windowIndex = this.findWindowIndex(selectParts);\n        if (windowIndex !== -1) {\n          // replace current window function\n          selectParts[windowIndex] = partModel;\n        } else {\n          const aggIndex = this.findAggregateIndex(selectParts);\n          if (aggIndex !== -1) {\n            selectParts.splice(aggIndex + 1, 0, partModel);\n          } else {\n            selectParts.splice(1, 0, partModel);\n          }\n        }\n        if (!find(selectParts, (p: any) => p.def.type === 'alias')) {\n          addAlias = true;\n        }\n        break;\n      case 'alias':\n        addAlias = true;\n        break;\n    }\n\n    if (addAlias) {\n      // set initial alias name to column name\n      partModel = sqlPart.create({ type: 'alias', params: [selectParts[0].params[0].replace(/\"/g, '')] });\n      if (selectParts[selectParts.length - 1].def.type === 'alias') {\n        selectParts[selectParts.length - 1] = partModel;\n      } else {\n        selectParts.push(partModel);\n      }\n    }\n\n    this.updatePersistedParts();\n    this.updateRawSqlAndRefresh();\n  }\n\n  removeSelectPart(selectParts: any, part: { def: { type: string } }) {\n    if (part.def.type === 'column') {\n      // remove all parts of column unless its last column\n      if (this.selectParts.length > 1) {\n        const modelsIndex = indexOf(this.selectParts, selectParts);\n        this.selectParts.splice(modelsIndex, 1);\n      }\n    } else {\n      const partIndex = indexOf(selectParts, part);\n      selectParts.splice(partIndex, 1);\n    }\n\n    this.updatePersistedParts();\n  }\n\n  handleSelectPartEvent(selectParts: any, part: { def: any }, evt: { name: any }) {\n    switch (evt.name) {\n      case 'get-param-options': {\n        switch (part.def.type) {\n          case 'aggregate':\n            return this.datasource\n              .metricFindQuery(this.metaBuilder.buildAggregateQuery())\n              .then(this.transformToSegments({}))\n              .catch(this.handleQueryError.bind(this));\n          case 'column':\n            return this.datasource\n              .metricFindQuery(this.metaBuilder.buildColumnQuery('value'))\n              .then(this.transformToSegments({}))\n              .catch(this.handleQueryError.bind(this));\n        }\n      }\n      case 'part-param-changed': {\n        this.updatePersistedParts();\n        this.updateRawSqlAndRefresh();\n        break;\n      }\n      case 'action': {\n        this.removeSelectPart(selectParts, part);\n        this.updateRawSqlAndRefresh();\n        break;\n      }\n      case 'get-part-actions': {\n        return Promise.resolve([{ text: 'Remove', value: 'remove-part' }]);\n      }\n    }\n  }\n\n  handleGroupPartEvent(part: any, index: any, evt: { name: any }) {\n    switch (evt.name) {\n      case 'get-param-options': {\n        return this.datasource\n          .metricFindQuery(this.metaBuilder.buildColumnQuery())\n          .then(this.transformToSegments({}))\n          .catch(this.handleQueryError.bind(this));\n      }\n      case 'part-param-changed': {\n        this.updatePersistedParts();\n        this.updateRawSqlAndRefresh();\n        break;\n      }\n      case 'action': {\n        this.removeGroup(part, index);\n        this.updateRawSqlAndRefresh();\n        break;\n      }\n      case 'get-part-actions': {\n        return Promise.resolve([{ text: 'Remove', value: 'remove-part' }]);\n      }\n    }\n  }\n\n  addGroup(partType: string, value: string) {\n    let params = [value];\n    if (partType === 'time') {\n      params = ['$__interval', 'none'];\n    }\n    const partModel = sqlPart.create({ type: partType, params: params });\n\n    if (partType === 'time') {\n      // put timeGroup at start\n      this.groupParts.splice(0, 0, partModel);\n    } else {\n      this.groupParts.push(partModel);\n    }\n\n    // add aggregates when adding group by\n    for (const selectParts of this.selectParts) {\n      if (!selectParts.some((part) => part.def.type === 'aggregate')) {\n        const aggregate = sqlPart.create({ type: 'aggregate', params: ['avg'] });\n        selectParts.splice(1, 0, aggregate);\n        if (!selectParts.some((part) => part.def.type === 'alias')) {\n          const alias = sqlPart.create({ type: 'alias', params: [selectParts[0].part.params[0]] });\n          selectParts.push(alias);\n        }\n      }\n    }\n\n    this.updatePersistedParts();\n  }\n\n  removeGroup(part: { def: { type: string } }, index: number) {\n    if (part.def.type === 'time') {\n      // remove aggregations\n      this.selectParts = map(this.selectParts, (s: any) => {\n        return filter(s, (part: any) => {\n          if (part.def.type === 'aggregate' || part.def.type === 'percentile') {\n            return false;\n          }\n          return true;\n        });\n      });\n    }\n\n    this.groupParts.splice(index, 1);\n    this.updatePersistedParts();\n  }\n\n  handleWherePartEvent(whereParts: any, part: any, evt: any, index: any) {\n    switch (evt.name) {\n      case 'get-param-options': {\n        switch (evt.param.name) {\n          case 'left':\n            return this.datasource\n              .metricFindQuery(this.metaBuilder.buildColumnQuery())\n              .then(this.transformToSegments({}))\n              .catch(this.handleQueryError.bind(this));\n          case 'right':\n            if (['int4', 'int8', 'float4', 'float8', 'timestamp', 'timestamptz'].indexOf(part.datatype) > -1) {\n              // don't do value lookups for numerical fields\n              return Promise.resolve([]);\n            } else {\n              return this.datasource\n                .metricFindQuery(this.metaBuilder.buildValueQuery(part.params[0]))\n                .then(\n                  this.transformToSegments({\n                    addTemplateVars: true,\n                    templateQuoter: (v: string) => {\n                      return this.queryModel.quoteLiteral(v);\n                    },\n                  })\n                )\n                .catch(this.handleQueryError.bind(this));\n            }\n          case 'op':\n            return Promise.resolve(this.uiSegmentSrv.newOperators(this.metaBuilder.getOperators(part.datatype)));\n          default:\n            return Promise.resolve([]);\n        }\n      }\n      case 'part-param-changed': {\n        this.updatePersistedParts();\n        this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(part.params[0])).then((d: any) => {\n          if (d.length === 1) {\n            part.datatype = d[0].text;\n          }\n        });\n        this.updateRawSqlAndRefresh();\n        break;\n      }\n      case 'action': {\n        // remove element\n        whereParts.splice(index, 1);\n        this.updatePersistedParts();\n        this.updateRawSqlAndRefresh();\n        break;\n      }\n      case 'get-part-actions': {\n        return Promise.resolve([{ text: 'Remove', value: 'remove-part' }]);\n      }\n    }\n  }\n\n  getWhereOptions() {\n    const options = [];\n    if (this.queryModel.hasUnixEpochTimecolumn()) {\n      options.push(this.uiSegmentSrv.newSegment({ type: 'macro', value: '$__unixEpochFilter' }));\n    } else {\n      options.push(this.uiSegmentSrv.newSegment({ type: 'macro', value: '$__timeFilter' }));\n    }\n    options.push(this.uiSegmentSrv.newSegment({ type: 'expression', value: 'Expression' }));\n    return Promise.resolve(options);\n  }\n\n  addWhereAction(part: any, index: any) {\n    switch (this.whereAdd.type) {\n      case 'macro': {\n        const partModel = sqlPart.create({ type: 'macro', name: this.whereAdd.value, params: [] });\n        if (this.whereParts.length >= 1 && this.whereParts[0].def.type === 'macro') {\n          // replace current macro\n          this.whereParts[0] = partModel;\n        } else {\n          this.whereParts.splice(0, 0, partModel);\n        }\n        break;\n      }\n      default: {\n        this.whereParts.push(sqlPart.create({ type: 'expression', params: ['value', '=', 'value'] }));\n      }\n    }\n\n    this.updatePersistedParts();\n    this.resetPlusButton(this.whereAdd);\n    this.updateRawSqlAndRefresh();\n  }\n\n  getGroupOptions() {\n    return this.datasource\n      .metricFindQuery(this.metaBuilder.buildColumnQuery('group'))\n      .then((tags: any) => {\n        const options = [];\n        if (!this.queryModel.hasTimeGroup()) {\n          options.push(this.uiSegmentSrv.newSegment({ type: 'time', value: 'time($__interval,none)' }));\n        }\n        for (const tag of tags) {\n          options.push(this.uiSegmentSrv.newSegment({ type: 'column', value: tag.text }));\n        }\n        return options;\n      })\n      .catch(this.handleQueryError.bind(this));\n  }\n\n  addGroupAction() {\n    this.addGroup(this.groupAdd.type, this.groupAdd.value);\n    this.resetPlusButton(this.groupAdd);\n    this.updateRawSqlAndRefresh();\n  }\n\n  handleQueryError(err: any): any[] {\n    this.error = err.message || 'Failed to issue metric query';\n    return [];\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}