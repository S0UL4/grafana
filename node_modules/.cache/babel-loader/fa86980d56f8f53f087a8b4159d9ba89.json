{"ast":null,"code":"import $ from 'jquery';\nimport _ from 'lodash'; // eslint-disable-line lodash/import-scope\n\nimport { setLegacyAngularInjector, setAppEvents, setAngularLoader } from '@grafana/runtime';\nimport { colors } from '@grafana/ui';\nimport coreModule from 'app/angular/core_module';\nimport appEvents from 'app/core/app_events';\nimport config from 'app/core/config';\nimport { initGrafanaLive } from 'app/features/live';\nimport { CoreEvents } from 'app/types';\nexport class GrafanaCtrl {\n  /** @ngInject */\n  constructor($scope, utilSrv, $rootScope, contextSrv, angularLoader, $injector) {\n    // make angular loader service available to react components\n    setAngularLoader(angularLoader);\n    setLegacyAngularInjector($injector);\n    setAppEvents(appEvents);\n    initGrafanaLive();\n\n    $scope.init = () => {\n      $scope.contextSrv = contextSrv;\n      $scope.appSubUrl = config.appSubUrl;\n      $scope._ = _;\n      utilSrv.init();\n    };\n\n    $rootScope.colors = colors;\n\n    $rootScope.onAppEvent = function (event, callback, localScope) {\n      let unbind;\n\n      if (typeof event === 'string') {\n        unbind = $rootScope.$on(event, callback);\n      } else {\n        unbind = $rootScope.$on(event.name, callback);\n      }\n\n      let callerScope = this;\n\n      if (callerScope.$id === 1 && !localScope) {\n        console.warn('warning rootScope onAppEvent called without localscope');\n      }\n\n      if (localScope) {\n        callerScope = localScope;\n      }\n\n      callerScope.$on('$destroy', unbind);\n    };\n\n    $rootScope.appEvent = (event, payload) => {\n      if (typeof event === 'string') {\n        $rootScope.$emit(event, payload);\n        appEvents.emit(event, payload);\n      } else {\n        $rootScope.$emit(event.name, payload);\n        appEvents.emit(event, payload);\n      }\n    };\n\n    $scope.init();\n  }\n\n}\nGrafanaCtrl.$inject = [\"$scope\", \"utilSrv\", \"$rootScope\", \"contextSrv\", \"angularLoader\", \"$injector\"];\n\n/** @ngInject */\nexport function grafanaAppDirective() {\n  return {\n    restrict: 'E',\n    controller: GrafanaCtrl,\n    link: (scope, elem) => {\n      const body = $('body'); // see https://github.com/zenorocha/clipboard.js/issues/155\n\n      $.fn.modal.Constructor.prototype.enforceFocus = () => {};\n\n      appEvents.on(CoreEvents.toggleSidemenuHidden, () => {\n        body.toggleClass('sidemenu-hidden');\n      }); // handle in active view state class\n\n      let lastActivity = new Date().getTime();\n      let activeUser = true;\n      const inActiveTimeLimit = 60 * 5000;\n\n      function checkForInActiveUser() {\n        if (!activeUser) {\n          return;\n        } // only go to activity low mode on dashboard page\n\n\n        if (!body.hasClass('page-dashboard')) {\n          return;\n        }\n\n        if (new Date().getTime() - lastActivity > inActiveTimeLimit) {\n          activeUser = false;\n          body.addClass('view-mode--inactive');\n        }\n      }\n\n      function userActivityDetected() {\n        lastActivity = new Date().getTime();\n\n        if (!activeUser) {\n          activeUser = true;\n          body.removeClass('view-mode--inactive');\n        }\n      } // mouse and keyboard is user activity\n\n\n      body.mousemove(userActivityDetected);\n      body.keydown(userActivityDetected); // set useCapture = true to catch event here\n\n      document.addEventListener('wheel', userActivityDetected, {\n        capture: true,\n        passive: true\n      }); // treat tab change as activity\n\n      document.addEventListener('visibilitychange', userActivityDetected); // check every 2 seconds\n\n      setInterval(checkForInActiveUser, 2000); // handle document clicks that should hide things\n\n      body.click(evt => {\n        const target = $(evt.target);\n\n        if (target.parents().length === 0) {\n          return;\n        } // ensure dropdown menu doesn't impact on z-index\n\n\n        body.find('.dropdown-menu-open').removeClass('dropdown-menu-open'); // for stuff that animates, slides out etc, clicking it needs to\n        // hide it right away\n\n        const clickAutoHide = target.closest('[data-click-hide]');\n\n        if (clickAutoHide.length) {\n          const clickAutoHideParent = clickAutoHide.parent();\n          clickAutoHide.detach();\n          setTimeout(() => {\n            clickAutoHideParent.append(clickAutoHide);\n          }, 100);\n        } // hide popovers\n\n\n        const popover = elem.find('.popover');\n\n        if (popover.length > 0 && target.parents('.graph-legend').length === 0) {\n          popover.hide();\n        }\n      });\n    }\n  };\n}\ncoreModule.directive('grafanaApp', grafanaAppDirective);","map":{"version":3,"names":["$","_","setLegacyAngularInjector","setAppEvents","setAngularLoader","colors","coreModule","appEvents","config","initGrafanaLive","CoreEvents","GrafanaCtrl","constructor","$scope","utilSrv","$rootScope","contextSrv","angularLoader","$injector","init","appSubUrl","onAppEvent","event","callback","localScope","unbind","$on","name","callerScope","$id","console","warn","appEvent","payload","$emit","emit","grafanaAppDirective","restrict","controller","link","scope","elem","body","fn","modal","Constructor","prototype","enforceFocus","on","toggleSidemenuHidden","toggleClass","lastActivity","Date","getTime","activeUser","inActiveTimeLimit","checkForInActiveUser","hasClass","addClass","userActivityDetected","removeClass","mousemove","keydown","document","addEventListener","capture","passive","setInterval","click","evt","target","parents","length","find","clickAutoHide","closest","clickAutoHideParent","parent","detach","setTimeout","append","popover","hide","directive"],"sources":["/home/soula/grafana/public/app/angular/GrafanaCtrl.ts"],"sourcesContent":["import { IRootScopeService, IAngularEvent, auto } from 'angular';\nimport $ from 'jquery';\nimport _ from 'lodash'; // eslint-disable-line lodash/import-scope\n\nimport { AppEvent } from '@grafana/data';\nimport { setLegacyAngularInjector, setAppEvents, setAngularLoader } from '@grafana/runtime';\nimport { colors } from '@grafana/ui';\nimport coreModule from 'app/angular/core_module';\nimport { AngularLoader } from 'app/angular/services/AngularLoader';\nimport appEvents from 'app/core/app_events';\nimport config from 'app/core/config';\nimport { ContextSrv } from 'app/core/services/context_srv';\nimport { initGrafanaLive } from 'app/features/live';\nimport { CoreEvents, AppEventEmitter, AppEventConsumer } from 'app/types';\n\nimport { UtilSrv } from './services/UtilSrv';\n\nexport type GrafanaRootScope = IRootScopeService & AppEventEmitter & AppEventConsumer & { colors: string[] };\n\nexport class GrafanaCtrl {\n  /** @ngInject */\n  constructor(\n    $scope: any,\n    utilSrv: UtilSrv,\n    $rootScope: GrafanaRootScope,\n    contextSrv: ContextSrv,\n    angularLoader: AngularLoader,\n    $injector: auto.IInjectorService\n  ) {\n    // make angular loader service available to react components\n    setAngularLoader(angularLoader);\n    setLegacyAngularInjector($injector);\n    setAppEvents(appEvents);\n\n    initGrafanaLive();\n\n    $scope.init = () => {\n      $scope.contextSrv = contextSrv;\n      $scope.appSubUrl = config.appSubUrl;\n      $scope._ = _;\n      utilSrv.init();\n    };\n\n    $rootScope.colors = colors;\n\n    $rootScope.onAppEvent = function <T>(\n      event: AppEvent<T> | string,\n      callback: (event: IAngularEvent, ...args: any[]) => void,\n      localScope?: any\n    ) {\n      let unbind;\n      if (typeof event === 'string') {\n        unbind = $rootScope.$on(event, callback);\n      } else {\n        unbind = $rootScope.$on(event.name, callback);\n      }\n\n      let callerScope = this;\n      if (callerScope.$id === 1 && !localScope) {\n        console.warn('warning rootScope onAppEvent called without localscope');\n      }\n      if (localScope) {\n        callerScope = localScope;\n      }\n      callerScope.$on('$destroy', unbind);\n    };\n\n    $rootScope.appEvent = <T>(event: AppEvent<T> | string, payload?: T | any) => {\n      if (typeof event === 'string') {\n        $rootScope.$emit(event, payload);\n        appEvents.emit(event, payload);\n      } else {\n        $rootScope.$emit(event.name, payload);\n        appEvents.emit(event, payload);\n      }\n    };\n\n    $scope.init();\n  }\n}\n\n/** @ngInject */\nexport function grafanaAppDirective() {\n  return {\n    restrict: 'E',\n    controller: GrafanaCtrl,\n    link: (scope: IRootScopeService & AppEventEmitter, elem: JQuery) => {\n      const body = $('body');\n      // see https://github.com/zenorocha/clipboard.js/issues/155\n      $.fn.modal.Constructor.prototype.enforceFocus = () => {};\n\n      appEvents.on(CoreEvents.toggleSidemenuHidden, () => {\n        body.toggleClass('sidemenu-hidden');\n      });\n\n      // handle in active view state class\n      let lastActivity = new Date().getTime();\n      let activeUser = true;\n      const inActiveTimeLimit = 60 * 5000;\n\n      function checkForInActiveUser() {\n        if (!activeUser) {\n          return;\n        }\n        // only go to activity low mode on dashboard page\n        if (!body.hasClass('page-dashboard')) {\n          return;\n        }\n\n        if (new Date().getTime() - lastActivity > inActiveTimeLimit) {\n          activeUser = false;\n          body.addClass('view-mode--inactive');\n        }\n      }\n\n      function userActivityDetected() {\n        lastActivity = new Date().getTime();\n        if (!activeUser) {\n          activeUser = true;\n          body.removeClass('view-mode--inactive');\n        }\n      }\n\n      // mouse and keyboard is user activity\n      body.mousemove(userActivityDetected);\n      body.keydown(userActivityDetected);\n      // set useCapture = true to catch event here\n      document.addEventListener('wheel', userActivityDetected, { capture: true, passive: true });\n      // treat tab change as activity\n      document.addEventListener('visibilitychange', userActivityDetected);\n\n      // check every 2 seconds\n      setInterval(checkForInActiveUser, 2000);\n\n      // handle document clicks that should hide things\n      body.click((evt) => {\n        const target = $(evt.target);\n        if (target.parents().length === 0) {\n          return;\n        }\n\n        // ensure dropdown menu doesn't impact on z-index\n        body.find('.dropdown-menu-open').removeClass('dropdown-menu-open');\n\n        // for stuff that animates, slides out etc, clicking it needs to\n        // hide it right away\n        const clickAutoHide = target.closest('[data-click-hide]');\n        if (clickAutoHide.length) {\n          const clickAutoHideParent = clickAutoHide.parent();\n          clickAutoHide.detach();\n          setTimeout(() => {\n            clickAutoHideParent.append(clickAutoHide);\n          }, 100);\n        }\n\n        // hide popovers\n        const popover = elem.find('.popover');\n        if (popover.length > 0 && target.parents('.graph-legend').length === 0) {\n          popover.hide();\n        }\n      });\n    },\n  };\n}\n\ncoreModule.directive('grafanaApp', grafanaAppDirective);\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}