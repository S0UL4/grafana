{"ast":null,"code":"const _excluded = [\"canAddAnnotations\", \"canEditAnnotations\", \"canDeleteAnnotations\"];\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nimport { css } from '@emotion/css';\nimport React, { useCallback, useRef, useState } from 'react';\nimport { usePopper } from 'react-popper';\nimport { dateTimeFormat, systemDateFormats } from '@grafana/data';\nimport { Portal, useStyles2, usePanelContext } from '@grafana/ui';\nimport { getTooltipContainerStyles } from '@grafana/ui/src/themes/mixins';\nimport { getCommonAnnotationStyles } from '../styles';\nimport { AnnotationEditorForm } from './AnnotationEditorForm';\nimport { AnnotationTooltip } from './AnnotationTooltip';\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nconst POPPER_CONFIG = {\n  modifiers: [{\n    name: 'arrow',\n    enabled: false\n  }, {\n    name: 'preventOverflow',\n    enabled: true,\n    options: {\n      rootBoundary: 'viewport'\n    }\n  }]\n};\nexport function AnnotationMarker({\n  annotation,\n  timeZone,\n  style\n}) {\n  const _usePanelContext = usePanelContext(),\n        {\n    canEditAnnotations,\n    canDeleteAnnotations\n  } = _usePanelContext,\n        panelCtx = _objectWithoutPropertiesLoose(_usePanelContext, _excluded);\n\n  const commonStyles = useStyles2(getCommonAnnotationStyles);\n  const styles = useStyles2(getStyles);\n  const [isOpen, setIsOpen] = useState(false);\n  const [isEditing, setIsEditing] = useState(false);\n  const [markerRef, setMarkerRef] = useState(null);\n  const [tooltipRef, setTooltipRef] = useState(null);\n  const [editorRef, setEditorRef] = useState(null);\n  const popoverRenderTimeout = useRef();\n  const popper = usePopper(markerRef, tooltipRef, POPPER_CONFIG);\n  const editorPopper = usePopper(markerRef, editorRef, POPPER_CONFIG);\n  const onAnnotationEdit = useCallback(() => {\n    setIsEditing(true);\n    setIsOpen(false);\n  }, [setIsEditing, setIsOpen]);\n  const onAnnotationDelete = useCallback(() => {\n    if (panelCtx.onAnnotationDelete) {\n      panelCtx.onAnnotationDelete(annotation.id);\n    }\n  }, [annotation, panelCtx]);\n  const onMouseEnter = useCallback(() => {\n    if (popoverRenderTimeout.current) {\n      clearTimeout(popoverRenderTimeout.current);\n    }\n\n    setIsOpen(true);\n  }, [setIsOpen]);\n  const onPopoverMouseEnter = useCallback(() => {\n    if (popoverRenderTimeout.current) {\n      clearTimeout(popoverRenderTimeout.current);\n    }\n  }, []);\n  const onMouseLeave = useCallback(() => {\n    popoverRenderTimeout.current = setTimeout(() => {\n      setIsOpen(false);\n    }, 100);\n  }, [setIsOpen]);\n  const timeFormatter = useCallback(value => {\n    return dateTimeFormat(value, {\n      format: systemDateFormats.fullDate,\n      timeZone\n    });\n  }, [timeZone]);\n  const renderTooltip = useCallback(() => {\n    return /*#__PURE__*/_jsx(AnnotationTooltip, {\n      annotation: annotation,\n      timeFormatter: timeFormatter,\n      onEdit: onAnnotationEdit,\n      onDelete: onAnnotationDelete,\n      canEdit: canEditAnnotations(annotation.dashboardId),\n      canDelete: canDeleteAnnotations(annotation.dashboardId)\n    });\n  }, [canEditAnnotations, canDeleteAnnotations, onAnnotationDelete, onAnnotationEdit, timeFormatter, annotation]);\n  const isRegionAnnotation = Boolean(annotation.isRegion);\n\n  let marker = /*#__PURE__*/_jsx(\"div\", {\n    className: commonStyles(annotation).markerTriangle,\n    style: {\n      transform: 'translate3d(-100%,-50%, 0)'\n    }\n  });\n\n  if (isRegionAnnotation) {\n    marker = /*#__PURE__*/_jsx(\"div\", {\n      className: commonStyles(annotation).markerBar,\n      style: Object.assign({}, style, {\n        transform: 'translate3d(0,-50%, 0)'\n      })\n    });\n  }\n\n  return /*#__PURE__*/_jsxs(_Fragment, {\n    children: [/*#__PURE__*/_jsx(\"div\", {\n      ref: setMarkerRef,\n      onMouseEnter: onMouseEnter,\n      onMouseLeave: onMouseLeave,\n      className: !isRegionAnnotation ? styles.markerWrapper : undefined,\n      children: marker\n    }), isOpen && /*#__PURE__*/_jsx(Portal, {\n      children: /*#__PURE__*/_jsx(\"div\", Object.assign({\n        ref: setTooltipRef,\n        style: popper.styles.popper\n      }, popper.attributes.popper, {\n        className: styles.tooltip,\n        onMouseEnter: onPopoverMouseEnter,\n        onMouseLeave: onMouseLeave,\n        children: renderTooltip()\n      }))\n    }), isEditing && /*#__PURE__*/_jsx(Portal, {\n      children: /*#__PURE__*/_jsx(AnnotationEditorForm, Object.assign({\n        onDismiss: () => setIsEditing(false),\n        onSave: () => setIsEditing(false),\n        timeFormatter: timeFormatter,\n        annotation: annotation,\n        ref: setEditorRef,\n        style: editorPopper.styles.popper\n      }, editorPopper.attributes.popper))\n    })]\n  });\n}\n\nconst getStyles = theme => {\n  return {\n    markerWrapper: css`\n      label: markerWrapper;\n      padding: 0 4px 4px 4px;\n    `,\n    wrapper: css`\n      max-width: 400px;\n    `,\n    tooltip: css`\n      ${getTooltipContainerStyles(theme)};\n      padding: 0;\n    `\n  };\n};","map":{"version":3,"names":["css","React","useCallback","useRef","useState","usePopper","dateTimeFormat","systemDateFormats","Portal","useStyles2","usePanelContext","getTooltipContainerStyles","getCommonAnnotationStyles","AnnotationEditorForm","AnnotationTooltip","POPPER_CONFIG","modifiers","name","enabled","options","rootBoundary","AnnotationMarker","annotation","timeZone","style","canEditAnnotations","canDeleteAnnotations","panelCtx","commonStyles","styles","getStyles","isOpen","setIsOpen","isEditing","setIsEditing","markerRef","setMarkerRef","tooltipRef","setTooltipRef","editorRef","setEditorRef","popoverRenderTimeout","popper","editorPopper","onAnnotationEdit","onAnnotationDelete","id","onMouseEnter","current","clearTimeout","onPopoverMouseEnter","onMouseLeave","setTimeout","timeFormatter","value","format","fullDate","renderTooltip","dashboardId","isRegionAnnotation","Boolean","isRegion","marker","markerTriangle","transform","markerBar","markerWrapper","undefined","attributes","tooltip","theme","wrapper"],"sources":["/home/soula/grafana/public/app/plugins/panel/timeseries/plugins/annotations/AnnotationMarker.tsx"],"sourcesContent":["import { css } from '@emotion/css';\nimport React, { HTMLAttributes, useCallback, useRef, useState } from 'react';\nimport { usePopper } from 'react-popper';\n\nimport { GrafanaTheme2, dateTimeFormat, systemDateFormats, TimeZone } from '@grafana/data';\nimport { Portal, useStyles2, usePanelContext } from '@grafana/ui';\nimport { getTooltipContainerStyles } from '@grafana/ui/src/themes/mixins';\n\nimport { getCommonAnnotationStyles } from '../styles';\n\nimport { AnnotationEditorForm } from './AnnotationEditorForm';\nimport { AnnotationTooltip } from './AnnotationTooltip';\n\ninterface Props extends HTMLAttributes<HTMLDivElement> {\n  timeZone: TimeZone;\n  annotation: AnnotationsDataFrameViewDTO;\n}\n\nconst POPPER_CONFIG = {\n  modifiers: [\n    { name: 'arrow', enabled: false },\n    {\n      name: 'preventOverflow',\n      enabled: true,\n      options: {\n        rootBoundary: 'viewport',\n      },\n    },\n  ],\n};\n\nexport function AnnotationMarker({ annotation, timeZone, style }: Props) {\n  const { canAddAnnotations, canEditAnnotations, canDeleteAnnotations, ...panelCtx } = usePanelContext();\n  const commonStyles = useStyles2(getCommonAnnotationStyles);\n  const styles = useStyles2(getStyles);\n\n  const [isOpen, setIsOpen] = useState(false);\n  const [isEditing, setIsEditing] = useState(false);\n  const [markerRef, setMarkerRef] = useState<HTMLDivElement | null>(null);\n  const [tooltipRef, setTooltipRef] = useState<HTMLDivElement | null>(null);\n  const [editorRef, setEditorRef] = useState<HTMLDivElement | null>(null);\n\n  const popoverRenderTimeout = useRef<NodeJS.Timer>();\n\n  const popper = usePopper(markerRef, tooltipRef, POPPER_CONFIG);\n  const editorPopper = usePopper(markerRef, editorRef, POPPER_CONFIG);\n\n  const onAnnotationEdit = useCallback(() => {\n    setIsEditing(true);\n    setIsOpen(false);\n  }, [setIsEditing, setIsOpen]);\n\n  const onAnnotationDelete = useCallback(() => {\n    if (panelCtx.onAnnotationDelete) {\n      panelCtx.onAnnotationDelete(annotation.id);\n    }\n  }, [annotation, panelCtx]);\n\n  const onMouseEnter = useCallback(() => {\n    if (popoverRenderTimeout.current) {\n      clearTimeout(popoverRenderTimeout.current);\n    }\n    setIsOpen(true);\n  }, [setIsOpen]);\n\n  const onPopoverMouseEnter = useCallback(() => {\n    if (popoverRenderTimeout.current) {\n      clearTimeout(popoverRenderTimeout.current);\n    }\n  }, []);\n\n  const onMouseLeave = useCallback(() => {\n    popoverRenderTimeout.current = setTimeout(() => {\n      setIsOpen(false);\n    }, 100);\n  }, [setIsOpen]);\n\n  const timeFormatter = useCallback(\n    (value: number) => {\n      return dateTimeFormat(value, {\n        format: systemDateFormats.fullDate,\n        timeZone,\n      });\n    },\n    [timeZone]\n  );\n\n  const renderTooltip = useCallback(() => {\n    return (\n      <AnnotationTooltip\n        annotation={annotation}\n        timeFormatter={timeFormatter}\n        onEdit={onAnnotationEdit}\n        onDelete={onAnnotationDelete}\n        canEdit={canEditAnnotations!(annotation.dashboardId)}\n        canDelete={canDeleteAnnotations!(annotation.dashboardId)}\n      />\n    );\n  }, [canEditAnnotations, canDeleteAnnotations, onAnnotationDelete, onAnnotationEdit, timeFormatter, annotation]);\n\n  const isRegionAnnotation = Boolean(annotation.isRegion);\n\n  let marker = (\n    <div className={commonStyles(annotation).markerTriangle} style={{ transform: 'translate3d(-100%,-50%, 0)' }} />\n  );\n\n  if (isRegionAnnotation) {\n    marker = (\n      <div className={commonStyles(annotation).markerBar} style={{ ...style, transform: 'translate3d(0,-50%, 0)' }} />\n    );\n  }\n  return (\n    <>\n      <div\n        ref={setMarkerRef}\n        onMouseEnter={onMouseEnter}\n        onMouseLeave={onMouseLeave}\n        className={!isRegionAnnotation ? styles.markerWrapper : undefined}\n      >\n        {marker}\n      </div>\n\n      {isOpen && (\n        <Portal>\n          <div\n            ref={setTooltipRef}\n            style={popper.styles.popper}\n            {...popper.attributes.popper}\n            className={styles.tooltip}\n            onMouseEnter={onPopoverMouseEnter}\n            onMouseLeave={onMouseLeave}\n          >\n            {renderTooltip()}\n          </div>\n        </Portal>\n      )}\n\n      {isEditing && (\n        <Portal>\n          <AnnotationEditorForm\n            onDismiss={() => setIsEditing(false)}\n            onSave={() => setIsEditing(false)}\n            timeFormatter={timeFormatter}\n            annotation={annotation}\n            ref={setEditorRef}\n            style={editorPopper.styles.popper}\n            {...editorPopper.attributes.popper}\n          />\n        </Portal>\n      )}\n    </>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    markerWrapper: css`\n      label: markerWrapper;\n      padding: 0 4px 4px 4px;\n    `,\n    wrapper: css`\n      max-width: 400px;\n    `,\n    tooltip: css`\n      ${getTooltipContainerStyles(theme)};\n      padding: 0;\n    `,\n  };\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}