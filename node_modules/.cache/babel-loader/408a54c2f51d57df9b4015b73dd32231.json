{"ast":null,"code":"queryPartEditorDirective.$inject = [\"templateSrv\"];\nimport $ from 'jquery';\nimport { debounce, each, map, partial, escape, unescape } from 'lodash';\nimport coreModule from 'app/angular/core_module';\nimport { promiseToDigest } from '../promiseToDigest';\nconst template = `\n<div class=\"dropdown cascade-open\">\n<a ng-click=\"showActionsMenu()\" class=\"query-part-name pointer dropdown-toggle\" data-toggle=\"dropdown\">{{part.def.type}}</a>\n<span>(</span><span class=\"query-part-parameters\"></span><span>)</span>\n<ul class=\"dropdown-menu\">\n  <li ng-repeat=\"action in partActions\">\n    <a ng-click=\"triggerPartAction(action)\">{{action.text}}</a>\n  </li>\n</ul>\n`;\n/** @ngInject */\n\nexport function queryPartEditorDirective(templateSrv) {\n  const paramTemplate = '<input type=\"text\" class=\"hide input-mini tight-form-func-param\"></input>';\n  return {\n    restrict: 'E',\n    template: template,\n    scope: {\n      part: '=',\n      handleEvent: '&',\n      debounce: '@'\n    },\n    link: function postLink($scope, elem) {\n      const part = $scope.part;\n      const partDef = part.def;\n      const $paramsContainer = elem.find('.query-part-parameters');\n      const debounceLookup = $scope.debounce;\n      $scope.partActions = [];\n\n      function clickFuncParam(paramIndex) {\n        const $link = $(this);\n        const $input = $link.next();\n        $input.val(part.params[paramIndex]);\n        $input.css('width', $link.width() + 16 + 'px');\n        $link.hide();\n        $input.show();\n        $input.focus();\n        $input.select();\n        const typeahead = $input.data('typeahead');\n\n        if (typeahead) {\n          $input.val('');\n          typeahead.lookup();\n        }\n      }\n\n      function inputBlur(paramIndex) {\n        const $input = $(this);\n        const $link = $input.prev();\n        const newValue = $input.val();\n\n        if (newValue !== '' || part.def.params[paramIndex].optional) {\n          $link.html(templateSrv.highlightVariablesAsHtml(newValue));\n          part.updateParam($input.val(), paramIndex);\n          $scope.$apply(() => {\n            $scope.handleEvent({\n              $event: {\n                name: 'part-param-changed'\n              }\n            });\n          });\n        }\n\n        $input.hide();\n        $link.show();\n      }\n\n      function inputKeyPress(paramIndex, e) {\n        if (e.which === 13) {\n          inputBlur.call(this, paramIndex);\n        }\n      }\n\n      function inputKeyDown() {\n        this.style.width = (3 + this.value.length) * 8 + 'px';\n      }\n\n      function addTypeahead($input, param, paramIndex) {\n        if (!param.options && !param.dynamicLookup) {\n          return;\n        }\n\n        const typeaheadSource = (query, callback) => {\n          if (param.options) {\n            let options = param.options;\n\n            if (param.type === 'int') {\n              options = map(options, val => {\n                return val.toString();\n              });\n            }\n\n            return options;\n          }\n\n          $scope.$apply(() => {\n            $scope.handleEvent({\n              $event: {\n                name: 'get-param-options'\n              }\n            }).then(result => {\n              const dynamicOptions = map(result, op => {\n                return escape(op.value);\n              });\n              callback(dynamicOptions);\n            });\n          });\n        };\n\n        $input.attr('data-provide', 'typeahead');\n        $input.typeahead({\n          source: typeaheadSource,\n          minLength: 0,\n          items: 1000,\n          updater: value => {\n            value = unescape(value);\n            setTimeout(() => {\n              inputBlur.call($input[0], paramIndex);\n            }, 0);\n            return value;\n          }\n        });\n        const typeahead = $input.data('typeahead');\n\n        typeahead.lookup = function () {\n          this.query = this.$element.val() || '';\n          const items = this.source(this.query, $.proxy(this.process, this));\n          return items ? this.process(items) : items;\n        };\n\n        if (debounceLookup) {\n          typeahead.lookup = debounce(typeahead.lookup, 500, {\n            leading: true\n          });\n        }\n      }\n\n      $scope.showActionsMenu = () => {\n        promiseToDigest($scope)($scope.handleEvent({\n          $event: {\n            name: 'get-part-actions'\n          }\n        }).then(res => {\n          $scope.partActions = res;\n        }));\n      };\n\n      $scope.triggerPartAction = action => {\n        $scope.handleEvent({\n          $event: {\n            name: 'action',\n            action: action\n          }\n        });\n      };\n\n      function addElementsAndCompile() {\n        each(partDef.params, (param, index) => {\n          if (param.optional && part.params.length <= index) {\n            return;\n          }\n\n          if (index > 0) {\n            $('<span>, </span>').appendTo($paramsContainer);\n          }\n\n          const paramValue = templateSrv.highlightVariablesAsHtml(part.params[index]);\n          const $paramLink = $('<a class=\"graphite-func-param-link pointer\">' + paramValue + '</a>');\n          const $input = $(paramTemplate);\n          $paramLink.appendTo($paramsContainer);\n          $input.appendTo($paramsContainer);\n          $input.blur(partial(inputBlur, index));\n          $input.keyup(inputKeyDown);\n          $input.keypress(partial(inputKeyPress, index));\n          $paramLink.click(partial(clickFuncParam, index));\n          addTypeahead($input, param, index);\n        });\n      }\n\n      function relink() {\n        $paramsContainer.empty();\n        addElementsAndCompile();\n      }\n\n      relink();\n    }\n  };\n}\ncoreModule.directive('queryPartEditor', queryPartEditorDirective);","map":{"version":3,"names":["$","debounce","each","map","partial","escape","unescape","coreModule","promiseToDigest","template","queryPartEditorDirective","templateSrv","paramTemplate","restrict","scope","part","handleEvent","link","postLink","$scope","elem","partDef","def","$paramsContainer","find","debounceLookup","partActions","clickFuncParam","paramIndex","$link","$input","next","val","params","css","width","hide","show","focus","select","typeahead","data","lookup","inputBlur","prev","newValue","optional","html","highlightVariablesAsHtml","updateParam","$apply","$event","name","inputKeyPress","e","which","call","inputKeyDown","style","value","length","addTypeahead","param","options","dynamicLookup","typeaheadSource","query","callback","type","toString","then","result","dynamicOptions","op","attr","source","minLength","items","updater","setTimeout","$element","proxy","process","leading","showActionsMenu","res","triggerPartAction","action","addElementsAndCompile","index","appendTo","paramValue","$paramLink","blur","keyup","keypress","click","relink","empty","directive"],"sources":["/home/soula/grafana/public/app/angular/components/query_part_editor.ts"],"sourcesContent":["import $ from 'jquery';\nimport { debounce, each, map, partial, escape, unescape } from 'lodash';\n\nimport coreModule from 'app/angular/core_module';\n\nimport { promiseToDigest } from '../promiseToDigest';\n\nconst template = `\n<div class=\"dropdown cascade-open\">\n<a ng-click=\"showActionsMenu()\" class=\"query-part-name pointer dropdown-toggle\" data-toggle=\"dropdown\">{{part.def.type}}</a>\n<span>(</span><span class=\"query-part-parameters\"></span><span>)</span>\n<ul class=\"dropdown-menu\">\n  <li ng-repeat=\"action in partActions\">\n    <a ng-click=\"triggerPartAction(action)\">{{action.text}}</a>\n  </li>\n</ul>\n`;\n\n/** @ngInject */\nexport function queryPartEditorDirective(templateSrv: any) {\n  const paramTemplate = '<input type=\"text\" class=\"hide input-mini tight-form-func-param\"></input>';\n\n  return {\n    restrict: 'E',\n    template: template,\n    scope: {\n      part: '=',\n      handleEvent: '&',\n      debounce: '@',\n    },\n    link: function postLink($scope: any, elem: any) {\n      const part = $scope.part;\n      const partDef = part.def;\n      const $paramsContainer = elem.find('.query-part-parameters');\n      const debounceLookup = $scope.debounce;\n\n      $scope.partActions = [];\n\n      function clickFuncParam(this: any, paramIndex: number) {\n        const $link = $(this);\n        const $input = $link.next();\n\n        $input.val(part.params[paramIndex]);\n        $input.css('width', $link.width()! + 16 + 'px');\n\n        $link.hide();\n        $input.show();\n        $input.focus();\n        $input.select();\n\n        const typeahead = $input.data('typeahead');\n        if (typeahead) {\n          $input.val('');\n          typeahead.lookup();\n        }\n      }\n\n      function inputBlur(this: any, paramIndex: number) {\n        const $input = $(this);\n        const $link = $input.prev();\n        const newValue = $input.val();\n\n        if (newValue !== '' || part.def.params[paramIndex].optional) {\n          $link.html(templateSrv.highlightVariablesAsHtml(newValue));\n\n          part.updateParam($input.val(), paramIndex);\n          $scope.$apply(() => {\n            $scope.handleEvent({ $event: { name: 'part-param-changed' } });\n          });\n        }\n\n        $input.hide();\n        $link.show();\n      }\n\n      function inputKeyPress(this: any, paramIndex: number, e: any) {\n        if (e.which === 13) {\n          inputBlur.call(this, paramIndex);\n        }\n      }\n\n      function inputKeyDown(this: any) {\n        this.style.width = (3 + this.value.length) * 8 + 'px';\n      }\n\n      function addTypeahead($input: JQuery, param: any, paramIndex: number) {\n        if (!param.options && !param.dynamicLookup) {\n          return;\n        }\n\n        const typeaheadSource = (query: string, callback: any) => {\n          if (param.options) {\n            let options = param.options;\n            if (param.type === 'int') {\n              options = map(options, (val) => {\n                return val.toString();\n              });\n            }\n            return options;\n          }\n\n          $scope.$apply(() => {\n            $scope.handleEvent({ $event: { name: 'get-param-options' } }).then((result: any) => {\n              const dynamicOptions = map(result, (op) => {\n                return escape(op.value);\n              });\n              callback(dynamicOptions);\n            });\n          });\n        };\n\n        $input.attr('data-provide', 'typeahead');\n\n        $input.typeahead({\n          source: typeaheadSource,\n          minLength: 0,\n          items: 1000,\n          updater: (value: string) => {\n            value = unescape(value);\n            setTimeout(() => {\n              inputBlur.call($input[0], paramIndex);\n            }, 0);\n            return value;\n          },\n        });\n\n        const typeahead = $input.data('typeahead');\n        typeahead.lookup = function () {\n          this.query = this.$element.val() || '';\n          const items = this.source(this.query, $.proxy(this.process, this));\n          return items ? this.process(items) : items;\n        };\n\n        if (debounceLookup) {\n          typeahead.lookup = debounce(typeahead.lookup, 500, { leading: true });\n        }\n      }\n\n      $scope.showActionsMenu = () => {\n        promiseToDigest($scope)(\n          $scope.handleEvent({ $event: { name: 'get-part-actions' } }).then((res: any) => {\n            $scope.partActions = res;\n          })\n        );\n      };\n\n      $scope.triggerPartAction = (action: string) => {\n        $scope.handleEvent({ $event: { name: 'action', action: action } });\n      };\n\n      function addElementsAndCompile() {\n        each(partDef.params, (param: any, index: number) => {\n          if (param.optional && part.params.length <= index) {\n            return;\n          }\n\n          if (index > 0) {\n            $('<span>, </span>').appendTo($paramsContainer);\n          }\n\n          const paramValue = templateSrv.highlightVariablesAsHtml(part.params[index]);\n          const $paramLink = $('<a class=\"graphite-func-param-link pointer\">' + paramValue + '</a>');\n          const $input = $(paramTemplate);\n\n          $paramLink.appendTo($paramsContainer);\n          $input.appendTo($paramsContainer);\n\n          $input.blur(partial(inputBlur, index));\n          $input.keyup(inputKeyDown);\n          $input.keypress(partial(inputKeyPress, index));\n          $paramLink.click(partial(clickFuncParam, index));\n\n          addTypeahead($input, param, index);\n        });\n      }\n\n      function relink() {\n        $paramsContainer.empty();\n        addElementsAndCompile();\n      }\n\n      relink();\n    },\n  };\n}\n\ncoreModule.directive('queryPartEditor', queryPartEditorDirective);\n"],"mappings":";AAAA,OAAOA,CAAP,MAAc,QAAd;AACA,SAASC,QAAT,EAAmBC,IAAnB,EAAyBC,GAAzB,EAA8BC,OAA9B,EAAuCC,MAAvC,EAA+CC,QAA/C,QAA+D,QAA/D;AAEA,OAAOC,UAAP,MAAuB,yBAAvB;AAEA,SAASC,eAAT,QAAgC,oBAAhC;AAEA,MAAMC,QAAQ,GAAI;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CATA;AAWA;;AACA,OAAO,SAASC,wBAAT,CAAkCC,WAAlC,EAAoD;EACzD,MAAMC,aAAa,GAAG,2EAAtB;EAEA,OAAO;IACLC,QAAQ,EAAE,GADL;IAELJ,QAAQ,EAAEA,QAFL;IAGLK,KAAK,EAAE;MACLC,IAAI,EAAE,GADD;MAELC,WAAW,EAAE,GAFR;MAGLf,QAAQ,EAAE;IAHL,CAHF;IAQLgB,IAAI,EAAE,SAASC,QAAT,CAAkBC,MAAlB,EAA+BC,IAA/B,EAA0C;MAC9C,MAAML,IAAI,GAAGI,MAAM,CAACJ,IAApB;MACA,MAAMM,OAAO,GAAGN,IAAI,CAACO,GAArB;MACA,MAAMC,gBAAgB,GAAGH,IAAI,CAACI,IAAL,CAAU,wBAAV,CAAzB;MACA,MAAMC,cAAc,GAAGN,MAAM,CAAClB,QAA9B;MAEAkB,MAAM,CAACO,WAAP,GAAqB,EAArB;;MAEA,SAASC,cAAT,CAAmCC,UAAnC,EAAuD;QACrD,MAAMC,KAAK,GAAG7B,CAAC,CAAC,IAAD,CAAf;QACA,MAAM8B,MAAM,GAAGD,KAAK,CAACE,IAAN,EAAf;QAEAD,MAAM,CAACE,GAAP,CAAWjB,IAAI,CAACkB,MAAL,CAAYL,UAAZ,CAAX;QACAE,MAAM,CAACI,GAAP,CAAW,OAAX,EAAoBL,KAAK,CAACM,KAAN,KAAiB,EAAjB,GAAsB,IAA1C;QAEAN,KAAK,CAACO,IAAN;QACAN,MAAM,CAACO,IAAP;QACAP,MAAM,CAACQ,KAAP;QACAR,MAAM,CAACS,MAAP;QAEA,MAAMC,SAAS,GAAGV,MAAM,CAACW,IAAP,CAAY,WAAZ,CAAlB;;QACA,IAAID,SAAJ,EAAe;UACbV,MAAM,CAACE,GAAP,CAAW,EAAX;UACAQ,SAAS,CAACE,MAAV;QACD;MACF;;MAED,SAASC,SAAT,CAA8Bf,UAA9B,EAAkD;QAChD,MAAME,MAAM,GAAG9B,CAAC,CAAC,IAAD,CAAhB;QACA,MAAM6B,KAAK,GAAGC,MAAM,CAACc,IAAP,EAAd;QACA,MAAMC,QAAQ,GAAGf,MAAM,CAACE,GAAP,EAAjB;;QAEA,IAAIa,QAAQ,KAAK,EAAb,IAAmB9B,IAAI,CAACO,GAAL,CAASW,MAAT,CAAgBL,UAAhB,EAA4BkB,QAAnD,EAA6D;UAC3DjB,KAAK,CAACkB,IAAN,CAAWpC,WAAW,CAACqC,wBAAZ,CAAqCH,QAArC,CAAX;UAEA9B,IAAI,CAACkC,WAAL,CAAiBnB,MAAM,CAACE,GAAP,EAAjB,EAA+BJ,UAA/B;UACAT,MAAM,CAAC+B,MAAP,CAAc,MAAM;YAClB/B,MAAM,CAACH,WAAP,CAAmB;cAAEmC,MAAM,EAAE;gBAAEC,IAAI,EAAE;cAAR;YAAV,CAAnB;UACD,CAFD;QAGD;;QAEDtB,MAAM,CAACM,IAAP;QACAP,KAAK,CAACQ,IAAN;MACD;;MAED,SAASgB,aAAT,CAAkCzB,UAAlC,EAAsD0B,CAAtD,EAA8D;QAC5D,IAAIA,CAAC,CAACC,KAAF,KAAY,EAAhB,EAAoB;UAClBZ,SAAS,CAACa,IAAV,CAAe,IAAf,EAAqB5B,UAArB;QACD;MACF;;MAED,SAAS6B,YAAT,GAAiC;QAC/B,KAAKC,KAAL,CAAWvB,KAAX,GAAmB,CAAC,IAAI,KAAKwB,KAAL,CAAWC,MAAhB,IAA0B,CAA1B,GAA8B,IAAjD;MACD;;MAED,SAASC,YAAT,CAAsB/B,MAAtB,EAAsCgC,KAAtC,EAAkDlC,UAAlD,EAAsE;QACpE,IAAI,CAACkC,KAAK,CAACC,OAAP,IAAkB,CAACD,KAAK,CAACE,aAA7B,EAA4C;UAC1C;QACD;;QAED,MAAMC,eAAe,GAAG,CAACC,KAAD,EAAgBC,QAAhB,KAAkC;UACxD,IAAIL,KAAK,CAACC,OAAV,EAAmB;YACjB,IAAIA,OAAO,GAAGD,KAAK,CAACC,OAApB;;YACA,IAAID,KAAK,CAACM,IAAN,KAAe,KAAnB,EAA0B;cACxBL,OAAO,GAAG5D,GAAG,CAAC4D,OAAD,EAAW/B,GAAD,IAAS;gBAC9B,OAAOA,GAAG,CAACqC,QAAJ,EAAP;cACD,CAFY,CAAb;YAGD;;YACD,OAAON,OAAP;UACD;;UAED5C,MAAM,CAAC+B,MAAP,CAAc,MAAM;YAClB/B,MAAM,CAACH,WAAP,CAAmB;cAAEmC,MAAM,EAAE;gBAAEC,IAAI,EAAE;cAAR;YAAV,CAAnB,EAA8DkB,IAA9D,CAAoEC,MAAD,IAAiB;cAClF,MAAMC,cAAc,GAAGrE,GAAG,CAACoE,MAAD,EAAUE,EAAD,IAAQ;gBACzC,OAAOpE,MAAM,CAACoE,EAAE,CAACd,KAAJ,CAAb;cACD,CAFyB,CAA1B;cAGAQ,QAAQ,CAACK,cAAD,CAAR;YACD,CALD;UAMD,CAPD;QAQD,CAnBD;;QAqBA1C,MAAM,CAAC4C,IAAP,CAAY,cAAZ,EAA4B,WAA5B;QAEA5C,MAAM,CAACU,SAAP,CAAiB;UACfmC,MAAM,EAAEV,eADO;UAEfW,SAAS,EAAE,CAFI;UAGfC,KAAK,EAAE,IAHQ;UAIfC,OAAO,EAAGnB,KAAD,IAAmB;YAC1BA,KAAK,GAAGrD,QAAQ,CAACqD,KAAD,CAAhB;YACAoB,UAAU,CAAC,MAAM;cACfpC,SAAS,CAACa,IAAV,CAAe1B,MAAM,CAAC,CAAD,CAArB,EAA0BF,UAA1B;YACD,CAFS,EAEP,CAFO,CAAV;YAGA,OAAO+B,KAAP;UACD;QAVc,CAAjB;QAaA,MAAMnB,SAAS,GAAGV,MAAM,CAACW,IAAP,CAAY,WAAZ,CAAlB;;QACAD,SAAS,CAACE,MAAV,GAAmB,YAAY;UAC7B,KAAKwB,KAAL,GAAa,KAAKc,QAAL,CAAchD,GAAd,MAAuB,EAApC;UACA,MAAM6C,KAAK,GAAG,KAAKF,MAAL,CAAY,KAAKT,KAAjB,EAAwBlE,CAAC,CAACiF,KAAF,CAAQ,KAAKC,OAAb,EAAsB,IAAtB,CAAxB,CAAd;UACA,OAAOL,KAAK,GAAG,KAAKK,OAAL,CAAaL,KAAb,CAAH,GAAyBA,KAArC;QACD,CAJD;;QAMA,IAAIpD,cAAJ,EAAoB;UAClBe,SAAS,CAACE,MAAV,GAAmBzC,QAAQ,CAACuC,SAAS,CAACE,MAAX,EAAmB,GAAnB,EAAwB;YAAEyC,OAAO,EAAE;UAAX,CAAxB,CAA3B;QACD;MACF;;MAEDhE,MAAM,CAACiE,eAAP,GAAyB,MAAM;QAC7B5E,eAAe,CAACW,MAAD,CAAf,CACEA,MAAM,CAACH,WAAP,CAAmB;UAAEmC,MAAM,EAAE;YAAEC,IAAI,EAAE;UAAR;QAAV,CAAnB,EAA6DkB,IAA7D,CAAmEe,GAAD,IAAc;UAC9ElE,MAAM,CAACO,WAAP,GAAqB2D,GAArB;QACD,CAFD,CADF;MAKD,CAND;;MAQAlE,MAAM,CAACmE,iBAAP,GAA4BC,MAAD,IAAoB;QAC7CpE,MAAM,CAACH,WAAP,CAAmB;UAAEmC,MAAM,EAAE;YAAEC,IAAI,EAAE,QAAR;YAAkBmC,MAAM,EAAEA;UAA1B;QAAV,CAAnB;MACD,CAFD;;MAIA,SAASC,qBAAT,GAAiC;QAC/BtF,IAAI,CAACmB,OAAO,CAACY,MAAT,EAAiB,CAAC6B,KAAD,EAAa2B,KAAb,KAA+B;UAClD,IAAI3B,KAAK,CAAChB,QAAN,IAAkB/B,IAAI,CAACkB,MAAL,CAAY2B,MAAZ,IAAsB6B,KAA5C,EAAmD;YACjD;UACD;;UAED,IAAIA,KAAK,GAAG,CAAZ,EAAe;YACbzF,CAAC,CAAC,iBAAD,CAAD,CAAqB0F,QAArB,CAA8BnE,gBAA9B;UACD;;UAED,MAAMoE,UAAU,GAAGhF,WAAW,CAACqC,wBAAZ,CAAqCjC,IAAI,CAACkB,MAAL,CAAYwD,KAAZ,CAArC,CAAnB;UACA,MAAMG,UAAU,GAAG5F,CAAC,CAAC,iDAAiD2F,UAAjD,GAA8D,MAA/D,CAApB;UACA,MAAM7D,MAAM,GAAG9B,CAAC,CAACY,aAAD,CAAhB;UAEAgF,UAAU,CAACF,QAAX,CAAoBnE,gBAApB;UACAO,MAAM,CAAC4D,QAAP,CAAgBnE,gBAAhB;UAEAO,MAAM,CAAC+D,IAAP,CAAYzF,OAAO,CAACuC,SAAD,EAAY8C,KAAZ,CAAnB;UACA3D,MAAM,CAACgE,KAAP,CAAarC,YAAb;UACA3B,MAAM,CAACiE,QAAP,CAAgB3F,OAAO,CAACiD,aAAD,EAAgBoC,KAAhB,CAAvB;UACAG,UAAU,CAACI,KAAX,CAAiB5F,OAAO,CAACuB,cAAD,EAAiB8D,KAAjB,CAAxB;UAEA5B,YAAY,CAAC/B,MAAD,EAASgC,KAAT,EAAgB2B,KAAhB,CAAZ;QACD,CAtBG,CAAJ;MAuBD;;MAED,SAASQ,MAAT,GAAkB;QAChB1E,gBAAgB,CAAC2E,KAAjB;QACAV,qBAAqB;MACtB;;MAEDS,MAAM;IACP;EAhKI,CAAP;AAkKD;AAED1F,UAAU,CAAC4F,SAAX,CAAqB,iBAArB,EAAwCzF,wBAAxC"},"metadata":{},"sourceType":"module"}